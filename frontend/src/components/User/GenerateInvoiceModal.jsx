import React, { useState, useEffect, useRef } from 'react';
import { FiX, FiDownload, FiInfo } from 'react-icons/fi';
import Button from '../Common/Button';
import api from '../../services/api';
import { toPng, toJpeg } from 'html-to-image';
import jsPDF from 'jspdf';
import SignatureCanvas from 'react-signature-canvas';

const GenerateInvoiceModal = ({ isOpen, onClose, booking, onSave }) => {
  const [invoiceType, setInvoiceType] = useState('');
  const [invoiceNumber, setInvoiceNumber] = useState('');
  const [invoiceDate, setInvoiceDate] = useState(new Date().toISOString().split('T')[0]);
  const [dueDate, setDueDate] = useState('');
  const [dpPercentage, setDpPercentage] = useState(30);
  const [companySettings, setCompanySettings] = useState(null);
  const [dpInputValue, setDpInputValue] = useState('');
  const [isSaving, setIsSaving] = useState(false);
  const [showDownloadModal, setShowDownloadModal] = useState(false);
  const [downloadFormat, setDownloadFormat] = useState('pdf');
  const [fileName, setFileName] = useState('');
  const [logoSize, setLogoSize] = useState(() => {
    // Load from localStorage or default to 32
    return parseInt(localStorage.getItem('invoiceLogoSize') || '32');
  });
  const invoiceRef = useRef(null);
  const autoGeneratedInvoiceRef = useRef(false);
  const signatureRef = useRef(null);
  const [signatureData, setSignatureData] = useState(null);
  const [recipientName, setRecipientName] = useState('');
  const [recipientPosition, setRecipientPosition] = useState('');
  
  // Kuitansi specific states
  const [kuitansiDate, setKuitansiDate] = useState(new Date().toISOString().split('T')[0]);
  const [paymentMethod, setPaymentMethod] = useState('transfer'); // 'transfer' or 'cash'
  
  // State untuk menyimpan tampilan invoice yang dipilih (bukan status pembayaran)
  const [savedInvoiceDisplay, setSavedInvoiceDisplay] = useState(null);

  // Helper: build invoice number string for a given date and counter
  const buildInvoiceNumber = (dateObj, counter) => {
    const day = String(dateObj.getDate()).padStart(2, '0');
    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
    const year = dateObj.getFullYear();
    const dateStr = `${day}${month}${year}`;
    const counterStr = String(counter).padStart(4, '0');
    return `INV-${dateStr}-${counterStr}`;
  };

  // Peek next invoice number for today without incrementing counter in localStorage
  const peekNextInvoiceNumber = () => {
    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    const dateStr = `${day}${month}${year}`;
    const counterKey = `invoice_counter_${dateStr}`;
    const current = parseInt(localStorage.getItem(counterKey) || '0');
    const next = current + 1;
    return buildInvoiceNumber(today, next);
  };

  // Increment and persist the invoice counter for a given date (used when saving)
  const persistInvoiceCounterForNumber = (invNumber) => {
    if (!invNumber || typeof invNumber !== 'string') return;
    // Expect format INV-DDMMYYYY-CCCC
    const parts = invNumber.split('-');
    if (parts.length < 3) return;
    const dateStr = parts[1];
    const counterStr = parts[2];
    const counter = parseInt(counterStr) || 0;
    if (!dateStr) return;
    const counterKey = `invoice_counter_${dateStr}`;
    const existing = parseInt(localStorage.getItem(counterKey) || '0');
    // Only update if counter is greater than existing
    if (counter > existing) {
      localStorage.setItem(counterKey, String(counter));
    }
  };

  useEffect(() => {
    if (isOpen && booking) {
      console.log('=== BOOKING DATA RECEIVED ===');
      console.log('Full booking object:', JSON.stringify(booking, null, 2));
      console.log('booking.booking_date:', booking.booking_date);
      console.log('booking.booking_time:', booking.booking_time);
      console.log('booking.booking_time_end:', booking.booking_time_end);
      console.log('booking.booking_details:', booking.booking_details);
      console.log('booking.notes:', booking.notes);
      
      if (booking.booking_details) {
        console.log('booking_details.booking_time:', booking.booking_details.booking_time);
        console.log('booking_details.booking_time_end:', booking.booking_details.booking_time_end);
        console.log('booking_details.booking_date:', booking.booking_details.booking_date);
        console.log('booking_details.booking_date_end:', booking.booking_details.booking_date_end);
      }
      
      // Try to parse booking_details from notes if not already parsed
      if (!booking.booking_details && booking.notes) {
        try {
          const parsedDetails = JSON.parse(booking.notes);
          booking.booking_details = parsedDetails;
          console.log('Parsed booking_details from notes:', parsedDetails);
        } catch (e) {
          console.log('Notes is not JSON format, treating as plain text');
        }
      }
      
      console.log('============================');
      
      // Check if invoice number already exists in booking details
      let invNumber = '';
      let savedInvoiceType = '';
      let savedDpPercentage = 30;
      let savedDpAmount = 0;
      
      if (booking.booking_details && booking.booking_details.invoice_number) {
        invNumber = booking.booking_details.invoice_number;
        console.log('Using existing invoice number:', invNumber);
        autoGeneratedInvoiceRef.current = false;
        
        // Restore saved invoice type and DP settings
        if (booking.booking_details.invoice_type) {
          savedInvoiceType = booking.booking_details.invoice_type;
          console.log('Restoring saved invoice type:', savedInvoiceType);
        }
        
        if (booking.booking_details.dp_percentage) {
          savedDpPercentage = booking.booking_details.dp_percentage;
          console.log('Restoring saved DP percentage:', savedDpPercentage);
        }
        
        if (booking.booking_details.dp_amount) {
          savedDpAmount = booking.booking_details.dp_amount;
          console.log('Restoring saved DP amount:', savedDpAmount);
        }
      } else {
        // Peek next invoice number (do NOT persist yet)
        invNumber = peekNextInvoiceNumber();
        console.log('Peeked new invoice number (not persisted):', invNumber);
        autoGeneratedInvoiceRef.current = true;
      }
      setInvoiceNumber(invNumber);
      setInvoiceType(savedInvoiceType);
      setDpPercentage(savedDpPercentage);
      
      if (savedDpAmount > 0) {
        setDpInputValue(savedDpAmount.toLocaleString('id-ID'));
      }

      const due = new Date();
      due.setDate(due.getDate() + 30);
      setDueDate(due.toISOString().split('T')[0]);

      // Restore tampilan invoice yang disimpan sebelumnya (jika ada)
      const savedDisplay = localStorage.getItem(`invoice_display_${booking.id}`);
      if (savedDisplay) {
        try {
          const displayData = JSON.parse(savedDisplay);
          setSavedInvoiceDisplay(displayData);
          setInvoiceType(displayData.invoiceType || '');
          if (displayData.dpPercentage) setDpPercentage(displayData.dpPercentage);
          if (displayData.dpInputValue) setDpInputValue(displayData.dpInputValue);
          console.log('Restored saved invoice display:', displayData);
        } catch (e) {
          console.error('Error parsing saved invoice display:', e);
        }
      } else {
        // Set invoice type based on payment status (primary logic)
        let finalInvoiceType = '';

        // Priority 1: Payment status determines available invoice types
        if (booking.payment_status === 'Lunas' || booking.payment_status === 'paid') {
          // Status sudah lunas, hanya bisa invoice penuh
          finalInvoiceType = 'penuh';
        } else if (booking.payment_status === 'DP' || booking.payment_status === 'partial') {
          // Status sudah DP, hanya bisa invoice pelunasan
          finalInvoiceType = 'pelunasan';
        } else {
          // Status belum bayar, gunakan saved invoice type jika ada
          if (savedInvoiceType) {
            finalInvoiceType = savedInvoiceType;
          } else {
            finalInvoiceType = '';
          }
        }

        setInvoiceType(finalInvoiceType);
      }

      // Set DP input value based on saved data or existing payment
      if (savedDpAmount > 0) {
        setDpInputValue(savedDpAmount.toLocaleString('id-ID'));
      } else if (booking.amount_paid > 0) {
        setDpInputValue(booking.amount_paid.toLocaleString('id-ID'));
        const percentage = (booking.amount_paid / (booking.total_amount * 1.02)) * 100;
        setDpPercentage(parseFloat(percentage.toFixed(2)));
      } else {
        setDpInputValue('');
      }

      fetchCompanySettings();
    }
  }, [isOpen, booking]);

  const fetchCompanySettings = async () => {
    try {
      const response = await api.get('/user/company-settings');
      if (response.data.success && response.data.data) {
        console.log('=== COMPANY SETTINGS DEBUG ===');
        console.log('Company Settings Data:', response.data.data);
        console.log('Bank 1 - Name:', response.data.data.bank_name);
        console.log('Bank 1 - Account Number:', response.data.data.account_number);
        console.log('Bank 1 - Account Holder:', response.data.data.account_holder_name);
        console.log('Bank 2 - Name:', response.data.data.bank_name_alt);
        console.log('Bank 2 - Account Number:', response.data.data.account_number_alt);
        console.log('Bank 2 - Account Holder:', response.data.data.account_holder_name_alt);
        console.log('============================');
        setCompanySettings(response.data.data);
      }
    } catch (error) {
      console.error('Error fetching company settings:', error);
    }
  };

  const calculateInvoiceAmounts = () => {
    if (!booking) return { 
      subtotal: 0, 
      dp: 0, 
      remaining: 0, 
      total: 0, 
      tax: 0, 
      alreadyPaid: 0,
      discount: 0,
      services: [],
      additional_fees: [],
      tax_percentage: 0
    };

    // Parse booking details if available
    let bookingDetails = booking.booking_details;
    const bookingDays = bookingDetails?.booking_days || 1;
    
    // Calculate subtotal from services or use total_amount
    let servicesSubtotal = 0;
    let servicesList = [];
    
    if (bookingDetails && bookingDetails.services && bookingDetails.services.length > 0) {
      // New format: use booking_details
      servicesList = bookingDetails.services;
      servicesSubtotal = bookingDetails.services.reduce((sum, service) => {
        const price = parseFloat(service.custom_price || 0);
        const quantity = parseInt(service.quantity) || 1;
        return sum + (price * quantity);
      }, 0);
      // Multiply by booking days
      servicesSubtotal = servicesSubtotal * bookingDays;
    } else if (booking.services && booking.services.length > 0) {
      // Legacy format: create service list from booking.services (service names only)
      // Use total_amount as price since we don't have individual prices
      servicesList = booking.services.map(serviceName => ({
        service_name: serviceName,
        custom_price: parseFloat(booking.total_amount)
      }));
      servicesSubtotal = parseFloat(booking.total_amount);
    } else {
      // Fallback: no services data
      servicesSubtotal = parseFloat(booking.total_amount);
    }
    
    // Get discount and additional fees from booking details
    const discount = bookingDetails?.discount || 0;
    const discountType = bookingDetails?.discount_type || 'rupiah'; // Ambil tipe diskon
    const additional_fees = bookingDetails?.additional_fees || [];
    const tax_percentage = bookingDetails?.tax_percentage || 0;
    
    // Calculate additional fees total
    const additionalFeesTotal = additional_fees.reduce((sum, fee) => {
      return sum + parseFloat(fee.amount || 0);
    }, 0);
    
    // Calculate discount amount based on type
    let discountAmount = 0;
    if (discount > 0) {
      if (discountType === 'persen') {
        discountAmount = (servicesSubtotal * discount) / 100;
      } else {
        discountAmount = discount;
      }
    }
    
    // Calculate subtotal after discount
    const subtotalAfterDiscount = servicesSubtotal - discountAmount;
    
    // Calculate tax
    const tax = (subtotalAfterDiscount * tax_percentage) / 100;
    
    // Calculate final total
    const total = subtotalAfterDiscount + tax + additionalFeesTotal;
    
    // Gunakan nilai dari input manual jika ada, jika tidak gunakan perhitungan dari percentage
    let dpAmount = (total * dpPercentage) / 100;
    if (dpInputValue && invoiceType === 'dp') {
      const manualValue = parseFloat(dpInputValue.replace(/\./g, ''));
      if (!isNaN(manualValue) && manualValue > 0) {
        dpAmount = manualValue;
      }
    }
    
    // alreadyPaid = yang sudah dibayar sebelumnya (tidak berubah di UI)
    // remaining = sisa setelah DP baru (untuk preview)
    const alreadyPaid = booking.amount_paid || 0;
    let remaining = total - dpAmount; // Sisa dihitung dari DP baru
    
    if (invoiceType === 'pelunasan') {
      // Untuk pelunasan, remaining adalah sisa setelah amount_paid
      remaining = total - alreadyPaid;
    }

    return {
      subtotal: subtotalAfterDiscount, // Subtotal setelah diskon
      servicesSubtotal, // Total layanan murni untuk tabel
      subtotalAfterDiscount,
      dp: dpAmount,
      remaining,
      total,
      tax,
      discount,
      discountAmount, // Tambahkan discountAmount
      discountType, // Tambahkan discountType
      alreadyPaid,
      services: servicesList,
      additional_fees,
      additionalFeesTotal,
      tax_percentage
    };
  };

  const amounts = calculateInvoiceAmounts();
  
  // Define bookingDetails at component level for use in JSX
  const bookingDetails = booking?.booking_details;
  
  // Helper function to format phone number: add +62 prefix with space
  const formatPhoneNumber = (phone) => {
    if (!phone) return '';
    // Remove all spaces and special characters except numbers
    const cleaned = phone.replace(/[^\d]/g, '');
    // If starts with 62, add +62 and space
    if (cleaned.startsWith('62')) {
      return `+62 ${cleaned.substring(2)}`;
    }
    // If starts with 0, replace with +62 and space
    if (cleaned.startsWith('0')) {
      return `+62 ${cleaned.substring(1)}`;
    }
    // Otherwise, add +62 and space
    return `+62 ${cleaned}`;
  };
  
  // Helper function to convert number to Indonesian words
  const numberToWords = (num) => {
    const units = ['', 'Satu', 'Dua', 'Tiga', 'Empat', 'Lima', 'Enam', 'Tujuh', 'Delapan', 'Sembilan'];
    const teens = ['Sepuluh', 'Sebelas', 'Dua Belas', 'Tiga Belas', 'Empat Belas', 'Lima Belas', 'Enam Belas', 'Tujuh Belas', 'Delapan Belas', 'Sembilan Belas'];
    const tens = ['', '', 'Dua Puluh', 'Tiga Puluh', 'Empat Puluh', 'Lima Puluh', 'Enam Puluh', 'Tujuh Puluh', 'Delapan Puluh', 'Sembilan Puluh'];
    const thousands = ['', 'Ribu', 'Juta', 'Miliar', 'Triliun'];
    
    if (num === 0) return 'Nol';
    
    const convertLessThanThousand = (n) => {
      if (n === 0) return '';
      if (n < 10) return units[n];
      if (n < 20) return teens[n - 10];
      if (n < 100) {
        const ten = Math.floor(n / 10);
        const unit = n % 10;
        return tens[ten] + (unit > 0 ? ' ' + units[unit] : '');
      }
      if (n < 1000) {
        const hundred = Math.floor(n / 100);
        const remainder = n % 100;
        let result = '';
        if (hundred === 1) {
          result = 'Seratus';
        } else if (hundred > 1) {
          result = units[hundred] + ' Ratus';
        }
        if (remainder > 0) {
          const remainderWords = convertLessThanThousand(remainder);
          result += (result ? ' ' : '') + remainderWords;
        }
        return result;
      }
      return '';
    };
    
    const convert = (n) => {
      if (n === 0) return '';
      
      let result = '';
      let thousandIndex = 0;
      
      while (n > 0) {
        const chunk = n % 1000;
        if (chunk > 0) {
          const chunkWords = convertLessThanThousand(chunk);
          if (chunkWords) {
            const thousandWord = thousands[thousandIndex];
            result = chunkWords + (thousandWord ? ' ' + thousandWord : '') + (result ? ' ' + result : '');
          }
        }
        n = Math.floor(n / 1000);
        thousandIndex++;
      }
      
      return result.trim();
    };
    
    return convert(num) + ' Rupiah';
  };
  
  // Debug log amounts
  if (isOpen && booking) {
    console.log('=== CALCULATED AMOUNTS ===');
    console.log('Services:', amounts.services);
    console.log('Subtotal:', amounts.subtotal);
    console.log('Discount:', amounts.discount);
    console.log('Subtotal After Discount:', amounts.subtotalAfterDiscount);
    console.log('Tax %:', amounts.tax_percentage);
    console.log('Tax Amount:', amounts.tax);
    console.log('Additional Fees:', amounts.additional_fees);
    console.log('Additional Fees Total:', amounts.additionalFeesTotal);
    console.log('GRAND TOTAL:', amounts.total);
    console.log('==========================');
  }

  const getInvoiceAmount = () => {
    switch (invoiceType) {
      case 'dp':
        return amounts.dp;
      case 'pelunasan':
        return amounts.remaining;
      case 'penuh':
        return amounts.total;
      case 'kuitansi':
        return amounts.total; // Kuitansi menampilkan total pembayaran yang diterima
      default:
        return 0;
    }
  };

  const handleSaveInvoice = async () => {
    try {
      setIsSaving(true);
      
      let newPaymentStatus = booking.payment_status;
      let newAmountPaid = booking.amount_paid || 0;

      if (invoiceType === 'dp') {
        newPaymentStatus = 'partial';
        newAmountPaid = amounts.dp;
      } else if (invoiceType === 'pelunasan') {
        newPaymentStatus = 'paid';
        newAmountPaid = amounts.total;
      } else if (invoiceType === 'penuh') {
        newPaymentStatus = 'paid';
        newAmountPaid = amounts.total;
      }

      // Convert payment status to English for backend (database constraint) - update after newPaymentStatus is set
      let backendPaymentStatus = 'unpaid'; // default
      if (newPaymentStatus === 'Lunas' || newPaymentStatus === 'paid') {
        backendPaymentStatus = 'paid';
      } else if (newPaymentStatus === 'DP' || newPaymentStatus === 'partial') {
        backendPaymentStatus = 'partial';
      } else if (newPaymentStatus === 'Belum Bayar' || newPaymentStatus === 'unpaid') {
        backendPaymentStatus = 'unpaid';
      } else {
        // If status is already in English format, use it
        const validStatuses = ['paid', 'partial', 'unpaid'];
        backendPaymentStatus = validStatuses.includes(newPaymentStatus) ? newPaymentStatus : 'unpaid';
      }

      // Prepare booking details to save
      let bookingDetailsToSave = booking.booking_details;
      
      // If booking_details doesn't exist, try to parse from notes
      if (!bookingDetailsToSave && booking.notes) {
        try {
          bookingDetailsToSave = JSON.parse(booking.notes);
        } catch (e) {
          console.log('Notes is not JSON, creating new booking_details');
        }
      }
      
      // Update payment info in booking_details
      if (bookingDetailsToSave) {
        bookingDetailsToSave.payment_status = newPaymentStatus;
        bookingDetailsToSave.amount_paid = Math.round(newAmountPaid);
        // Save invoice number and type to booking details
        bookingDetailsToSave.invoice_number = invoiceNumber;
        bookingDetailsToSave.invoice_type = invoiceType;
        
        // Save DP settings if invoice type is DP
        if (invoiceType === 'dp') {
          bookingDetailsToSave.dp_percentage = dpPercentage;
          bookingDetailsToSave.dp_amount = parseFloat(dpInputValue.replace(/[^\d]/g, '')) || 0;
        }
      }

      // Extract date and time from booking_date if it's in ISO format
      let bookingDate = booking.booking_date;
      let bookingTime = booking.booking_time;
      
      if (booking.booking_date && booking.booking_date.includes('T')) {
        const dateObj = new Date(booking.booking_date);
        bookingDate = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD
        bookingTime = dateObj.toTimeString().split(' ')[0].substring(0, 5); // HH:MM
      }

      // Convert status to English for backend (database constraint)
      let backendStatus = 'confirmed'; // default
      if (booking.status === 'completed' || booking.status === 'Selesai') {
        backendStatus = 'completed';
      } else if (booking.status === 'cancelled' || booking.status === 'Dibatalkan') {
        backendStatus = 'cancelled';
      } else if (booking.status === 'confirmed' || booking.status === 'Dijadwalkan') {
        backendStatus = 'confirmed';
      } else {
        // If status is already in English format, use it
        const validStatuses = ['confirmed', 'completed', 'cancelled'];
        backendStatus = validStatuses.includes(booking.status) ? booking.status : 'confirmed';
      }

      console.log('=== SAVE INVOICE DEBUG ===');
      console.log('Booking ID:', booking.id);
      console.log('Service ID:', booking.service_id, 'Type:', typeof booking.service_id);
      console.log('Original booking_date:', booking.booking_date);
      console.log('Formatted booking_date:', bookingDate);
      console.log('Original booking_time:', booking.booking_time);
      console.log('Formatted booking_time:', bookingTime);
      console.log('Original Status:', booking.status);
      console.log('Converted Status:', backendStatus);
      console.log('Original Payment Status:', booking.payment_status);
      console.log('New Payment Status:', newPaymentStatus);
      console.log('Converted Payment Status:', backendPaymentStatus);
      console.log('Amount Paid:', Math.round(newAmountPaid));
      console.log('Total Amount:', amounts.total);
      console.log('Invoice Number:', invoiceNumber);
      console.log('========================');

      const requestBody = {
        service_id: parseInt(booking.service_id),
        booking_date: bookingDate,
        booking_time: bookingTime,
        location_name: booking.location_name || '',
        location_map_url: booking.location_map_url || '',
        status: backendStatus,
        total_amount: amounts.total,
        notes: bookingDetailsToSave ? JSON.stringify(bookingDetailsToSave) : booking.notes || '',
        payment_status: backendPaymentStatus,
        amount_paid: Math.round(newAmountPaid),
      };

      console.log('Request body:', requestBody);

      const response = await api.put(`/user/bookings/${booking.id}`, requestBody);

      // Persist invoice counter locally so the invoice number is reserved
      try {
        if (invoiceNumber && invoiceNumber.startsWith('INV-')) {
          persistInvoiceCounterForNumber(invoiceNumber);
        }
      } catch (err) {
        console.warn('Failed to persist invoice counter locally:', err);
      }

      alert('Invoice berhasil disimpan! Status pembayaran telah diupdate.');
      
      if (onSave) {
        onSave();
      }
      
      onClose();
    } catch (error) {
      console.error('Error saving invoice:', error);
      alert(`Gagal menyimpan invoice: ${error.response?.data?.message || error.message}`);
    } finally {
      setIsSaving(false);
    }
  };

  const handleSaveInvoiceDisplayOnly = async () => {
    try {
      setIsSaving(true);

      // For display only, keep the exact same payment status as original
      let backendPaymentStatus = 'unpaid'; // default
      if (booking.payment_status === 'Lunas') {
        backendPaymentStatus = 'paid';
      } else if (booking.payment_status === 'paid') {
        backendPaymentStatus = 'paid';
      } else if (booking.payment_status === 'DP') {
        backendPaymentStatus = 'partial';
      } else if (booking.payment_status === 'partial') {
        backendPaymentStatus = 'partial';
      } else if (booking.payment_status === 'Belum Bayar') {
        backendPaymentStatus = 'unpaid';
      } else if (booking.payment_status === 'unpaid') {
        backendPaymentStatus = 'unpaid';
      } else {
        // If status is already in English format, use it
        const validStatuses = ['paid', 'partial', 'unpaid'];
        backendPaymentStatus = validStatuses.includes(booking.payment_status) ? booking.payment_status : 'unpaid';
      }

      // Prepare booking details to save
      let bookingDetailsToSave = booking.booking_details;
      
      // If booking_details doesn't exist, try to parse from notes
      if (!bookingDetailsToSave && booking.notes) {
        try {
          bookingDetailsToSave = JSON.parse(booking.notes);
        } catch (e) {
          console.log('Notes is not JSON, creating new booking_details');
        }
      }
      
      // Update invoice number and type in booking_details (but keep payment status and amount paid COMPLETELY unchanged)
      if (bookingDetailsToSave) {
        bookingDetailsToSave.invoice_number = invoiceNumber;
        bookingDetailsToSave.invoice_type = invoiceType;
        
        // Save DP settings if invoice type is DP
        if (invoiceType === 'dp') {
          bookingDetailsToSave.dp_percentage = dpPercentage;
          bookingDetailsToSave.dp_amount = parseFloat(dpInputValue.replace(/[^\d]/g, '')) || 0;
        }
        
        // DO NOT change payment_status or amount_paid for display only
        // bookingDetailsToSave.payment_status = ... (removed)
        // bookingDetailsToSave.amount_paid = ... (removed)
      }

      // Extract date and time from booking_date if it's in ISO format
      let bookingDate = booking.booking_date;
      let bookingTime = booking.booking_time;
      
      if (booking.booking_date && booking.booking_date.includes('T')) {
        const dateObj = new Date(booking.booking_date);
        bookingDate = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD
        bookingTime = dateObj.toTimeString().split(' ')[0].substring(0, 5); // HH:MM
      }

      // Convert status to English for backend (database constraint)
      let backendStatus = 'confirmed'; // default
      if (booking.status === 'completed' || booking.status === 'Selesai') {
        backendStatus = 'completed';
      } else if (booking.status === 'cancelled' || booking.status === 'Dibatalkan') {
        backendStatus = 'cancelled';
      } else if (booking.status === 'confirmed' || booking.status === 'Dijadwalkan') {
        backendStatus = 'confirmed';
      } else {
        // If status is already in English format, use it
        const validStatuses = ['confirmed', 'completed', 'cancelled'];
        backendStatus = validStatuses.includes(booking.status) ? booking.status : 'confirmed';
      }

      console.log('=== SAVE INVOICE DISPLAY ONLY DEBUG ===');
      console.log('Booking ID:', booking.id);
      console.log('Invoice Number:', invoiceNumber);
      console.log('Payment Status (UNCHANGED):', booking.payment_status);
      console.log('Amount Paid (UNCHANGED):', Math.round(booking.amount_paid || 0));
      console.log('========================');

      const requestBody = {
        service_id: parseInt(booking.service_id),
        booking_date: bookingDate,
        booking_time: bookingTime,
        location_name: booking.location_name || '',
        location_map_url: booking.location_map_url || '',
        status: backendStatus,
        total_amount: amounts.total,
        notes: bookingDetailsToSave ? JSON.stringify(bookingDetailsToSave) : booking.notes || '',
        payment_status: backendPaymentStatus, // Keep EXACTLY the same payment status
        amount_paid: Math.round(booking.amount_paid || 0), // Keep EXACTLY the same amount paid
      };

      console.log('Request body:', requestBody);

      const response = await api.put(`/user/bookings/${booking.id}`, requestBody);

      // Persist invoice counter locally so the invoice number is reserved
      try {
        if (invoiceNumber && invoiceNumber.startsWith('INV-')) {
          persistInvoiceCounterForNumber(invoiceNumber);
        }
      } catch (err) {
        console.warn('Failed to persist invoice counter locally:', err);
      }

      alert('Invoice berhasil disimpan! (hanya untuk tampilan, status pembayaran tidak berubah)');
      
      if (onSave) {
        onSave();
      }
      
      onClose();
    } catch (error) {
      console.error('Error saving invoice display only:', error);
      alert(`Gagal menyimpan invoice: ${error.response?.data?.message || error.message}`);
    } finally {
      setIsSaving(false);
    }
  };

  const handleDownloadPDF = () => {
    if (!invoiceType) {
      alert('Pilih jenis invoice terlebih dahulu');
      return;
    }
    // Set default filename
    const defaultName = `${invoiceType === 'kuitansi' ? 'Kuitansi' : 'Invoice'}-${invoiceNumber || 'DRAFT'}-${booking?.client_name || 'Client'}`;
    setFileName(defaultName);
    setDownloadFormat('pdf');
    setShowDownloadModal(true);
  };

  const handleDownloadJPEG = () => {
    if (!invoiceType) {
      alert('Pilih jenis invoice terlebih dahulu');
      return;
    }
    // Set default filename
    const defaultName = `${invoiceType === 'kuitansi' ? 'Kuitansi' : 'Invoice'}-${invoiceNumber || 'DRAFT'}-${booking?.client_name || 'Client'}`;
    setFileName(defaultName);
    setDownloadFormat('jpeg');
    setShowDownloadModal(true);
  };

  const handleInvoicePaid = async () => {
    try {
      setIsSaving(true);
      
      let newPaymentStatus = booking.payment_status;
      let newAmountPaid = booking.amount_paid || 0;

      // Update status berdasarkan invoice type yang dipilih
      if (invoiceType === 'dp') {
        newPaymentStatus = 'partial';
        newAmountPaid = amounts.dp;
      } else if (invoiceType === 'pelunasan') {
        newPaymentStatus = 'paid';
        newAmountPaid = amounts.total;
      } else if (invoiceType === 'penuh') {
        newPaymentStatus = 'paid';
        newAmountPaid = amounts.total;
      } else if (invoiceType === 'kuitansi') {
        newPaymentStatus = 'paid';
        newAmountPaid = amounts.total;
      } else {
        alert('Silakan pilih tipe invoice terlebih dahulu');
        setIsSaving(false);
        return;
      }

      // Convert payment status to English for backend
      let backendPaymentStatus = 'unpaid';
      if (newPaymentStatus === 'Lunas' || newPaymentStatus === 'paid') {
        backendPaymentStatus = 'paid';
      } else if (newPaymentStatus === 'DP' || newPaymentStatus === 'partial') {
        backendPaymentStatus = 'partial';
      } else if (newPaymentStatus === 'Belum Bayar' || newPaymentStatus === 'unpaid') {
        backendPaymentStatus = 'unpaid';
      } else {
        const validStatuses = ['paid', 'partial', 'unpaid'];
        backendPaymentStatus = validStatuses.includes(newPaymentStatus) ? newPaymentStatus : 'unpaid';
      }

      // Prepare booking details to save
      let bookingDetailsToSave = booking.booking_details;
      
      if (!bookingDetailsToSave && booking.notes) {
        try {
          bookingDetailsToSave = JSON.parse(booking.notes);
        } catch (e) {
          console.log('Notes is not JSON, creating new booking_details');
        }
      }
      
      // Update payment info in booking_details
      if (bookingDetailsToSave) {
        bookingDetailsToSave.payment_status = newPaymentStatus;
        bookingDetailsToSave.amount_paid = Math.round(newAmountPaid);
        bookingDetailsToSave.invoice_number = invoiceNumber;
        bookingDetailsToSave.invoice_type = invoiceType;
        
        if (invoiceType === 'dp') {
          bookingDetailsToSave.dp_percentage = dpPercentage;
          bookingDetailsToSave.dp_amount = parseFloat(dpInputValue.replace(/[^\d]/g, '')) || 0;
        }
      }

      // Extract date and time
      let bookingDate = booking.booking_date;
      let bookingTime = booking.booking_time;
      
      if (booking.booking_date && booking.booking_date.includes('T')) {
        const dateObj = new Date(booking.booking_date);
        bookingDate = dateObj.toISOString().split('T')[0];
        bookingTime = dateObj.toTimeString().split(' ')[0].substring(0, 5);
      }

      // Convert status to English
      let backendStatus = 'confirmed';
      if (booking.status === 'completed' || booking.status === 'Selesai') {
        backendStatus = 'completed';
      } else if (booking.status === 'cancelled' || booking.status === 'Dibatalkan') {
        backendStatus = 'cancelled';
      } else if (booking.status === 'confirmed' || booking.status === 'Dijadwalkan') {
        backendStatus = 'confirmed';
      } else {
        const validStatuses = ['confirmed', 'completed', 'cancelled'];
        backendStatus = validStatuses.includes(booking.status) ? booking.status : 'confirmed';
      }

      console.log('=== INVOICE PAID DEBUG ===');
      console.log('Invoice Type:', invoiceType);
      console.log('New Payment Status:', newPaymentStatus);
      console.log('Converted Payment Status:', backendPaymentStatus);
      console.log('Amount Paid:', Math.round(newAmountPaid));
      console.log('========================');

      const requestBody = {
        service_id: parseInt(booking.service_id),
        booking_date: bookingDate,
        booking_time: bookingTime,
        location_name: booking.location_name || '',
        location_map_url: booking.location_map_url || '',
        status: backendStatus,
        total_amount: amounts.total,
        notes: bookingDetailsToSave ? JSON.stringify(bookingDetailsToSave) : booking.notes || '',
        payment_status: backendPaymentStatus,
        amount_paid: Math.round(newAmountPaid),
      };

      const response = await api.put(`/user/bookings/${booking.id}`, requestBody);

      // Persist invoice counter
      try {
        if (invoiceNumber && invoiceNumber.startsWith('INV-')) {
          persistInvoiceCounterForNumber(invoiceNumber);
        }
      } catch (err) {
        console.warn('Failed to persist invoice counter locally:', err);
      }

      // Clear saved invoice display setelah dibayar
      localStorage.removeItem(`invoice_display_${booking.id}`);

      alert(`Invoice berhasil ditandai sebagai dibayar! Status pembayaran diupdate menjadi ${invoiceType === 'dp' ? 'DP' : 'Lunas'}.`);
      
      if (onSave) {
        onSave();
      }
      
      onClose();
    } catch (error) {
      console.error('Error marking invoice as paid:', error);
      alert(`Gagal menandai invoice sebagai dibayar: ${error.response?.data?.message || error.message}`);
    } finally {
      setIsSaving(false);
    }
  };

  const executeDownload = async () => {
    if (!fileName.trim()) {
      alert('Nama file tidak boleh kosong');
      return;
    }

    try {
      const invoiceElement = invoiceRef.current;
      if (!invoiceElement) {
        alert('Invoice tidak ditemukan');
        return;
      }

      // Use html-to-image for more accurate rendering (preserves CSS exactly as shown in preview)
      const pixelRatio = 2.5; // High quality
      
      // Common options to skip external stylesheets (Google Fonts) that cause CORS errors
      const commonOptions = {
        pixelRatio: pixelRatio,
        backgroundColor: '#ffffff',
        skipFonts: true, // Skip external fonts to avoid CORS errors
        style: {
          transform: 'scale(1)',
          transformOrigin: 'top left'
        },
        filter: (node) => {
          // Skip external stylesheet links to avoid CORS errors
          if (node.tagName === 'LINK' && node.getAttribute('href')?.includes('fonts.googleapis.com')) {
            return false;
          }
          return true;
        }
      };
      
      if (downloadFormat === 'pdf') {
        // Generate PNG first for better quality in PDF
        const dataUrl = await toPng(invoiceElement, {
          ...commonOptions,
          quality: 1
        });
        
        // Create image to get dimensions
        const img = new Image();
        img.src = dataUrl;
        await new Promise((resolve) => { img.onload = resolve; });
        
        // Generate PDF - fit to one page, start from top
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 297; // A4 height in mm
        let imgHeight = (img.height * imgWidth) / img.width;
        
        // If content is taller than A4, scale it down to fit
        if (imgHeight > pageHeight) {
          imgHeight = pageHeight;
        }
        
        const pdf = new jsPDF('p', 'mm', 'a4');
        pdf.addImage(dataUrl, 'PNG', 0, 0, imgWidth, imgHeight);
        pdf.save(`${fileName}.pdf`);
      } else {
        // Generate JPEG with high quality
        const dataUrl = await toJpeg(invoiceElement, {
          ...commonOptions,
          quality: 0.95
        });
        
        // Download JPEG
        const link = document.createElement('a');
        link.href = dataUrl;
        link.download = `${fileName}.jpg`;
        link.click();
      }

      setShowDownloadModal(false);
      alert(`Invoice berhasil didownload sebagai ${downloadFormat.toUpperCase()}`);
    } catch (error) {
      console.error('Error downloading invoice:', error);
      alert('Gagal download invoice. Silakan coba lagi.');
    }
  };

  // Update dpInputValue when invoice type changes
  useEffect(() => {
    if (invoiceType === 'dp') {
      // Set initial value saat pertama kali buka
      const initialDp = Math.round((amounts.total * dpPercentage) / 100);
      setDpInputValue(initialDp.toLocaleString('id-ID'));
    }
  }, [invoiceType]);

  // Save logo size to localStorage when it changes
  useEffect(() => {
    localStorage.setItem('invoiceLogoSize', logoSize.toString());
  }, [logoSize]);

  // Reset signature when invoice type changes
  useEffect(() => {
    if (invoiceType !== 'kuitansi') {
      setSignatureData(null);
      setRecipientName('');
      setRecipientPosition('');
      if (signatureRef.current) {
        signatureRef.current.clear();
      }
    }
  }, [invoiceType]);

  // Simpan tampilan invoice saat user memilih tipe invoice
  useEffect(() => {
    if (invoiceType && booking?.id) {
      const displayData = {
        invoiceType,
        dpPercentage,
        dpInputValue,
        savedAt: new Date().toISOString()
      };
      localStorage.setItem(`invoice_display_${booking.id}`, JSON.stringify(displayData));
      console.log('Saved invoice display:', displayData);
    }
  }, [invoiceType, dpPercentage, dpInputValue, booking?.id]);

  // Load signature dan recipient data dari localStorage saat komponen dimuat
  useEffect(() => {
    const savedSignature = localStorage.getItem('kuitansi_signature');
    const savedRecipientName = localStorage.getItem('kuitansi_recipient_name');
    const savedRecipientPosition = localStorage.getItem('kuitansi_recipient_position');
    
    if (savedSignature) {
      setSignatureData(savedSignature);
    }
    if (savedRecipientName) {
      setRecipientName(savedRecipientName);
    }
    if (savedRecipientPosition) {
      setRecipientPosition(savedRecipientPosition);
    }
  }, []);

  // Save recipient name ke localStorage saat berubah
  useEffect(() => {
    if (recipientName.trim()) {
      localStorage.setItem('kuitansi_recipient_name', recipientName);
    }
  }, [recipientName]);

  // Save recipient position ke localStorage saat berubah
  useEffect(() => {
    if (recipientPosition.trim()) {
      localStorage.setItem('kuitansi_recipient_position', recipientPosition);
    }
  }, [recipientPosition]);

  // Save signature data ke localStorage saat berubah
  useEffect(() => {
    if (signatureData) {
      localStorage.setItem('kuitansi_signature', signatureData);
    }
  }, [signatureData]);

  if (!isOpen || !booking) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4">
      <div className="bg-white rounded-lg sm:rounded-xl shadow-xl w-full max-w-4xl max-h-[95vh] sm:max-h-[90vh] overflow-hidden flex flex-col">
        {/* Header */}
        <div className="bg-white border-b border-gray-200 px-3 sm:px-4 md:px-6 py-3 sm:py-4 flex items-center justify-between flex-shrink-0">
          <h2 className="text-base sm:text-lg md:text-xl font-bold text-gray-900">Generate Invoice</h2>
          <div className="flex items-center gap-1 sm:gap-2">
            <Button variant="secondary" size="sm" icon={<FiDownload />} onClick={handleDownloadPDF} className="flex px-1 sm:px-1.5 md:px-2 lg:px-3 py-0.5 sm:py-1 md:py-1.5 lg:py-2 text-xs sm:text-xs md:text-sm">
              PDF
            </Button>
            <Button variant="secondary" size="sm" icon={<FiDownload />} onClick={handleDownloadJPEG} className="flex px-1 sm:px-1.5 md:px-2 lg:px-3 py-0.5 sm:py-1 md:py-1.5 lg:py-2 text-xs sm:text-xs md:text-sm">
              JPEG
            </Button>
            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-colors p-0.5 sm:p-1">
              <FiX className="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 lg:w-6 lg:h-6" />
            </button>
          </div>
        </div>

        {/* Scrollable Content */}
        <div className="flex-1 overflow-y-auto">
          <div className="p-3 sm:p-4 md:p-6 space-y-4 sm:space-y-6 bg-gradient-to-br from-blue-50 to-indigo-50 border-b">
            {/* Info Banner */}
            <div className="bg-blue-100 border-l-4 border-blue-500 rounded-r-lg p-3 sm:p-4">
              <div className="flex items-start gap-2 sm:gap-3">
                <FiInfo className="w-4 h-4 sm:w-5 sm:h-5 text-blue-600 mt-0.5 flex-shrink-0" />
                <div className="text-xs sm:text-sm text-blue-800">
                  <p className="font-semibold mb-1">Informasi Perhitungan Bill:</p>
                  <ul className="space-y-1 ml-4 list-disc">
                    <li>Total bill dihitung dari harga layanan × jumlah hari × quantity</li>
                    <li>Diskon diterapkan pada total layanan sebelum PPN</li>
                    <li>PPN dihitung dari total setelah diskon</li>
                    <li>Biaya tambahan ditambahkan ke total akhir</li>
                  </ul>
                </div>
              </div>
            </div>

            <div>
              <h3 className="text-sm sm:text-base md:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">Pilih Jenis Invoice</h3>
              
              {/* Status Info untuk DP */}
              {(booking.payment_status === 'DP' || booking.payment_status === 'partial') && (
                <div className="mb-3 sm:mb-4 p-3 sm:p-4 bg-orange-50 border-l-4 border-orange-500 rounded-r-lg">
                  <div className="flex items-start gap-2 sm:gap-3">
                    <svg className="w-4 h-4 sm:w-5 sm:h-5 text-orange-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div>
                      <p className="text-xs sm:text-sm font-semibold text-orange-800 mb-1">⚠️ Status: Down Payment (DP) - Invoice Pelunasan Saja</p>
                      <p className="text-xs sm:text-sm text-orange-700">
                        Sudah dibayar: <span className="font-bold">Rp {Math.round(booking.amount_paid || 0).toLocaleString('id-ID')}</span>
                      </p>
                      <p className="text-xs sm:text-sm text-orange-700">
                        Sisa pembayaran: <span className="font-bold">Rp {Math.round(amounts.total - (booking.amount_paid || 0)).toLocaleString('id-ID')}</span>
                      </p>
                      <p className="text-xs text-orange-600 mt-1 italic">
                        ℹ️ Invoice DP sudah dibuat. Anda hanya dapat membuat Invoice Pelunasan untuk menyelesaikan pembayaran.
                      </p>
                    </div>
                  </div>
                </div>
              )}

              <p className="text-xs sm:text-sm text-gray-600 mb-3 sm:mb-4">
                {booking.payment_status === 'Lunas' || booking.payment_status === 'paid' 
                  ? '✓ Pembayaran sudah lunas - Invoice Penuh' 
                  : booking.payment_status === 'DP' || booking.payment_status === 'partial'
                  ? '⚠️ Hanya Invoice Pelunasan yang tersedia (DP sudah dibuat sebelumnya)'
                  : 'Pilih Invoice DP atau Invoice Penuh'}
              </p>
              
              {/* Invoice Type Buttons */}
              <div className="space-y-2 sm:space-y-3">
                <div className="grid grid-cols-2 gap-1.5 sm:gap-2 md:gap-4">
                  {/* Invoice DP */}
                  <button
                    type="button"
                    onClick={() => setInvoiceType('dp')}
                    disabled={
                      booking.payment_status === 'Lunas' || 
                      booking.payment_status === 'paid' || 
                      booking.payment_status === 'DP' || 
                      booking.payment_status === 'partial'
                    }
                    className={`relative flex flex-col items-center p-1.5 sm:p-2 md:p-3 lg:p-5 border-2 rounded-md sm:rounded-lg md:rounded-xl transition-all duration-200 ${
                      invoiceType === 'dp' 
                        ? 'border-blue-500 bg-blue-50 shadow-lg scale-105' 
                        : (booking.payment_status === 'Lunas' || booking.payment_status === 'paid' || booking.payment_status === 'DP' || booking.payment_status === 'partial')
                        ? 'border-gray-200 bg-gray-100 cursor-not-allowed opacity-50'
                        : 'border-gray-300 bg-white hover:border-blue-400 hover:shadow-md'
                    }`}
                  >
                    {invoiceType === 'dp' && (
                      <div className="absolute -top-0.5 -right-0.5 sm:-top-1 sm:-right-1 md:-top-2 md:-right-2 w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 lg:w-6 lg:h-6 bg-blue-500 rounded-full flex items-center justify-center">
                        <svg className="w-1.5 h-1.5 sm:w-2 sm:h-2 md:w-3 md:h-3 lg:w-4 lg:h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                          <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                        </svg>
                      </div>
                    )}
                    <div className="w-6 h-6 sm:w-8 sm:h-8 md:w-10 md:h-10 lg:w-12 lg:h-12 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mb-0.5 sm:mb-1 md:mb-2 lg:mb-3">
                      <span className="text-white font-bold text-xs sm:text-xs md:text-sm lg:text-lg">DP</span>
                    </div>
                    <div className="text-center">
                      <div className="font-semibold text-gray-900 text-xs sm:text-xs md:text-sm lg:text-base mb-0 sm:mb-0.5 md:mb-1">Invoice DP</div>
                      <div className="text-xs text-gray-500 hidden sm:block">
                        {(booking.payment_status === 'DP' || booking.payment_status === 'partial')
                          ? 'DP sudah dibuat'
                          : 'Pembayaran DP'}
                      </div>
                      <div className="text-xs text-gray-500 sm:hidden">
                        DP
                      </div>
                    </div>
                  </button>

                  {/* Invoice Pelunasan */}
                  <button
                    type="button"
                    onClick={() => setInvoiceType('pelunasan')}
                    disabled={
                      booking.payment_status !== 'DP' && 
                      booking.payment_status !== 'partial'
                    }
                    className={`relative flex flex-col items-center p-1.5 sm:p-2 md:p-3 lg:p-5 border-2 rounded-md sm:rounded-lg md:rounded-xl transition-all duration-200 ${
                      invoiceType === 'pelunasan' 
                        ? 'border-orange-500 bg-orange-50 shadow-lg scale-105' 
                        : (booking.payment_status !== 'DP' && booking.payment_status !== 'partial')
                        ? 'border-gray-200 bg-gray-100 cursor-not-allowed opacity-50'
                        : 'border-gray-300 bg-white hover:border-orange-400 hover:shadow-md'
                    }`}
                  >
                    {invoiceType === 'pelunasan' && (
                      <div className="absolute -top-0.5 -right-0.5 sm:-top-1 sm:-right-1 md:-top-2 md:-right-2 w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 lg:w-6 lg:h-6 bg-orange-500 rounded-full flex items-center justify-center">
                        <svg className="w-1.5 h-1.5 sm:w-2 sm:h-2 md:w-3 md:h-3 lg:w-4 lg:h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                          <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                        </svg>
                      </div>
                    )}
                    <div className="w-6 h-6 sm:w-8 sm:h-8 md:w-10 md:h-10 lg:w-12 lg:h-12 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center mb-0.5 sm:mb-1 md:mb-2 lg:mb-3">
                      <svg className="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 lg:w-6 lg:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </div>
                    <div className="text-center">
                      <div className="font-semibold text-gray-900 text-xs sm:text-xs md:text-sm lg:text-base mb-0 sm:mb-0.5 md:mb-1">Invoice Pelunasan</div>
                      <div className="text-xs text-gray-500 hidden sm:block">Sisa pembayaran</div>
                      <div className="text-xs text-gray-500 sm:hidden">
                        Pelunasan
                      </div>
                    </div>
                  </button>

                  {/* Invoice Penuh */}
                  <button
                    type="button"
                    onClick={() => setInvoiceType('penuh')}
                    disabled={
                      booking.payment_status === 'Lunas' || 
                      booking.payment_status === 'paid' || 
                      booking.payment_status === 'DP' || 
                      booking.payment_status === 'partial'
                    }
                    className={`relative flex flex-col items-center p-1.5 sm:p-2 md:p-3 lg:p-5 border-2 rounded-md sm:rounded-lg md:rounded-xl transition-all duration-200 ${
                      invoiceType === 'penuh' 
                        ? 'border-green-500 bg-green-50 shadow-lg scale-105' 
                        : (booking.payment_status === 'Lunas' || booking.payment_status === 'paid')
                        ? 'border-green-400 bg-green-50 cursor-default'
                        : (booking.payment_status === 'DP' || booking.payment_status === 'partial')
                        ? 'border-gray-200 bg-gray-100 cursor-not-allowed opacity-50'
                        : 'border-gray-300 bg-white hover:border-green-400 hover:shadow-md'
                    }`}
                  >
                    {invoiceType === 'penuh' && (
                      <div className="absolute -top-0.5 -right-0.5 sm:-top-1 sm:-right-1 md:-top-2 md:-right-2 w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 lg:w-6 lg:h-6 bg-green-500 rounded-full flex items-center justify-center">
                        <svg className="w-1.5 h-1.5 sm:w-2 sm:h-2 md:w-3 md:h-3 lg:w-4 lg:h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                          <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                        </svg>
                      </div>
                    )}
                    <div className="w-6 h-6 sm:w-8 sm:h-8 md:w-10 md:h-10 lg:w-12 lg:h-12 bg-gradient-to-br from-green-400 to-emerald-500 rounded-full flex items-center justify-center mb-0.5 sm:mb-1 md:mb-2 lg:mb-3">
                      <svg className="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 lg:w-6 lg:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </div>
                    <div className="text-center">
                      <div className="font-semibold text-gray-900 text-xs sm:text-xs md:text-sm lg:text-base mb-0 sm:mb-0.5 md:mb-1">Invoice Penuh</div>
                      <div className="text-xs text-gray-500 hidden sm:block">
                        {(booking.payment_status === 'DP' || booking.payment_status === 'partial')
                          ? 'Tidak tersedia untuk DP'
                          : 'Pembayaran langsung'}
                      </div>
                      <div className="text-xs text-gray-500 sm:hidden">
                        {(booking.payment_status === 'DP' || booking.payment_status === 'partial')
                          ? 'Tidak tersedia'
                          : 'Penuh'}
                      </div>
                    </div>
                  </button>

                  {/* Kuitansi */}
                  <button
                    type="button"
                    onClick={() => setInvoiceType('kuitansi')}
                    className={`relative flex flex-col items-center p-1.5 sm:p-2 md:p-3 lg:p-5 border-2 rounded-md sm:rounded-lg md:rounded-xl transition-all duration-200 ${
                      invoiceType === 'kuitansi' 
                        ? 'border-purple-500 bg-purple-50 shadow-lg scale-105' 
                        : 'border-gray-300 bg-white hover:border-purple-400 hover:shadow-md'
                    }`}
                  >
                    {invoiceType === 'kuitansi' && (
                      <div className="absolute -top-0.5 -right-0.5 sm:-top-1 sm:-right-1 md:-top-2 md:-right-2 w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 lg:w-6 lg:h-6 bg-purple-500 rounded-full flex items-center justify-center">
                        <svg className="w-1.5 h-1.5 sm:w-2 sm:h-2 md:w-3 md:h-3 lg:w-4 lg:h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                          <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                        </svg>
                      </div>
                    )}
                    <div className="w-6 h-6 sm:w-8 sm:h-8 md:w-10 md:h-10 lg:w-12 lg:h-12 bg-gradient-to-br from-purple-400 to-pink-500 rounded-full flex items-center justify-center mb-0.5 sm:mb-1 md:mb-2 lg:mb-3">
                      <svg className="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 lg:w-6 lg:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                      </svg>
                    </div>
                    <div className="text-center">
                      <div className="font-semibold text-gray-900 text-xs sm:text-xs md:text-sm lg:text-base mb-0 sm:mb-0.5 md:mb-1">Kuitansi</div>
                      <div className="text-xs text-gray-500 hidden sm:block">Bukti pembayaran</div>
                      <div className="text-xs text-gray-500 sm:hidden">
                        Kuitansi
                      </div>
                    </div>
                  </button>
                </div>
                
                {/* DP Input Section */}
                {invoiceType === 'dp' && (
                  <div className="mt-3 sm:mt-4 p-3 sm:p-5 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg sm:rounded-xl border-2 border-yellow-200 shadow-sm">
                    <label className="flex text-xs sm:text-sm font-semibold text-gray-800 mb-2 sm:mb-3 items-center gap-2">
                      <div className="w-5 h-5 sm:w-6 sm:h-6 bg-yellow-500 rounded-full flex items-center justify-center">
                        <span className="text-white text-xs font-bold">%</span>
                      </div>
                      Persentase Down Payment (DP)
                    </label>
                    
                    {/* Slider dan Input Persentase */}
                    <div className="flex items-center gap-3 sm:gap-4 mb-2 sm:mb-3">
                      <input
                        type="range"
                        min="1"
                        max="90"
                        step="1"
                        value={dpPercentage}
                        onChange={(e) => {
                          const newPercentage = parseInt(e.target.value);
                          setDpPercentage(newPercentage);
                          // Update nominal input value
                          const newDpAmount = Math.round((amounts.total * newPercentage) / 100);
                          setDpInputValue(newDpAmount.toLocaleString('id-ID'));
                        }}
                        className="flex-1 h-2 bg-yellow-200 rounded-lg appearance-none cursor-pointer slider"
                        style={{
                          background: `linear-gradient(to right, #f59e0b 0%, #f59e0b ${(dpPercentage/90)*100}%, #fef3c7 ${(dpPercentage/90)*100}%, #fef3c7 100%)`
                        }}
                      />
                      <div className="relative">
                        <div className="w-20 sm:w-24 px-3 sm:px-4 py-1 sm:py-2 text-base sm:text-lg md:text-2xl font-bold text-yellow-600 text-center bg-white rounded-lg border-2 border-yellow-300">
                          {Math.round(dpPercentage)}%
                        </div>
                      </div>
                    </div>
                    
                    {/* Input Nominal DP Manual */}
                    <div className="mt-3 sm:mt-4 p-2 sm:p-3 bg-white rounded-lg border-2 border-yellow-300">
                      <label className="block text-xs font-semibold text-gray-700 mb-1 sm:mb-2">
                        Atau masukkan nominal DP langsung:
                      </label>
                      <div className="relative">
                        <span className="absolute left-2 sm:left-3 top-1/2 -translate-y-1/2 text-gray-500 font-medium text-sm sm:text-base">Rp</span>
                        <input
                          type="text"
                          value={dpInputValue}
                          onChange={(e) => {
                            const value = e.target.value.replace(/\./g, '');
                            const numValue = parseInt(value) || 0;
                            const maxDp = Math.round((amounts.total * 90) / 100);
                            
                            // Batasi maksimal 90% dari total
                            const clampedValue = Math.min(numValue, maxDp);
                            
                            setDpInputValue(clampedValue > 0 ? clampedValue.toLocaleString('id-ID') : '');
                            
                            // Update persentase berdasarkan nominal
                            const percentage = clampedValue > 0 ? (clampedValue / amounts.total) * 100 : 0;
                            setDpPercentage(parseFloat(percentage.toFixed(2)));
                          }}
                          placeholder="0"
                          className="w-full pl-8 sm:pl-10 pr-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 font-semibold text-gray-700 text-sm sm:text-base"
                        />
                      </div>
                      <p className="text-xs text-gray-500 mt-1 italic">
                        Total: Rp {Math.round(amounts.total).toLocaleString('id-ID')} | Maksimal DP (90%): Rp {Math.round((amounts.total * 90) / 100).toLocaleString('id-ID')}
                      </p>
                    </div>
                    
                    <div className="mt-3 text-sm text-gray-700 bg-white/60 p-3 rounded-lg">
                      <div className="flex justify-between items-center">
                        <span>Jumlah DP ({dpPercentage.toFixed(2)}%):</span>
                        <span className="font-bold text-yellow-700 text-sm sm:text-base md:text-lg">
                          Rp {Math.round(amounts.dp).toLocaleString('id-ID')}
                        </span>
                      </div>
                    </div>
                    
                    {/* Warning jika mendekati atau mencapai 90% */}
                    {dpPercentage >= 85 && (
                      <div className="mt-3 p-3 bg-orange-50 border-l-4 border-orange-500 rounded-r-lg">
                        <div className="flex items-start gap-2">
                          <svg className="w-5 h-5 text-orange-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                          </svg>
                          <div className="text-xs text-orange-800">
                            <p className="font-semibold">
                              {dpPercentage >= 90 ? '⚠️ DP maksimal 90% tercapai!' : '⚠️ DP mendekati batas maksimal'}
                            </p>
                            <p className="mt-1">Maksimal DP adalah 90% dari total pembayaran (Rp {Math.round((amounts.total * 90) / 100).toLocaleString('id-ID')})</p>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Kuitansi Custom Fields */}
                {invoiceType === 'kuitansi' && (
                  <div className="mt-2 sm:mt-3 md:mt-4">
                    <div className="p-2 sm:p-3 md:p-5 bg-white rounded-lg sm:rounded-xl border-2 border-gray-200 shadow-lg">
                      <h4 className="flex font-bold text-gray-900 mb-2 sm:mb-3 md:mb-4 items-center gap-1.5 sm:gap-2 text-sm sm:text-base md:text-lg">
                        <div className="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center">
                          <svg className="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                        </div>
                        Informasi Pembayaran
                      </h4>
                      
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 sm:gap-4">
                        <div>
                          <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                            Tanggal Pembayaran
                          </label>
                          <input
                            type="date"
                            value={kuitansiDate}
                            onChange={(e) => setKuitansiDate(e.target.value)}
                            className="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-xs sm:text-sm"
                          />
                        </div>
                        
                        <div>
                          <label className="block text-xs sm:text-sm font-medium text-gray-700 mb-1 sm:mb-2">
                            Diterima Melalui
                          </label>
                          <select
                            value={paymentMethod}
                            onChange={(e) => setPaymentMethod(e.target.value)}
                            className="w-full px-2 sm:px-3 py-1.5 sm:py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent text-xs sm:text-sm"
                          >
                            <option value="transfer">Transfer Bank</option>
                            <option value="cash">Tunai/Cash</option>
                          </select>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* Signature Section for Kuitansi */}
                {invoiceType === 'kuitansi' && (
                  <div className="mt-3 sm:mt-4 p-3 sm:p-5 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg sm:rounded-xl border-2 border-purple-200 shadow-sm">
                    <label className="flex text-xs sm:text-sm font-semibold text-gray-800 mb-2 sm:mb-3 items-center gap-2">
                      <div className="w-5 h-5 sm:w-6 sm:h-6 bg-purple-500 rounded-full flex items-center justify-center">
                        <svg className="w-3 h-3 sm:w-4 sm:h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>
                      </div>
                      Tanda Tangan Digital (untuk Kuitansi)
                    </label>
                    
                    <div className="bg-white p-3 rounded-lg border-2 border-purple-300">
                      {/* Input Nama dan Jabatan */}
                      <div className="mb-3 space-y-3">
                        <div>
                          <label className="block text-xs font-semibold text-gray-700 mb-1">
                            Nama Penerima
                          </label>
                          <input
                            type="text"
                            placeholder="Masukkan nama penerima"
                            className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm"
                            value={recipientName}
                            onChange={(e) => setRecipientName(e.target.value)}
                          />
                        </div>
                        <div>
                          <label className="block text-xs font-semibold text-gray-700 mb-1">
                            Jabatan
                          </label>
                          <input
                            type="text"
                            placeholder="Masukkan jabatan"
                            className="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-sm"
                            value={recipientPosition}
                            onChange={(e) => setRecipientPosition(e.target.value)}
                          />
                        </div>
                      </div>

                      <div className="mb-3">
                        <p className="text-xs text-gray-600 mb-2">
                          Tanda tangan di bawah ini akan muncul pada kuitansi sebagai bukti pembayaran telah diterima.
                        </p>
                        <div 
                          className="border-2 border-gray-300 rounded-lg overflow-hidden"
                          style={{ width: '100%', maxWidth: '400px' }}
                        >
                          <SignatureCanvas
                            ref={signatureRef}
                            canvasProps={{
                              width: 400,
                              height: 150,
                              className: 'signature-canvas',
                              style: { 
                                border: 'none',
                                width: '100%',
                                height: '150px',
                                maxWidth: '400px',
                                touchAction: 'none'
                              }
                            }}
                            backgroundColor="rgba(255,255,255,0.8)"
                            penColor="black"
                            minWidth={1}
                            maxWidth={3}
                          />
                        </div>
                      </div>
                      
                      <div className="flex gap-2">
                        <Button
                          variant="secondary"
                          size="sm"
                          onClick={() => signatureRef.current?.clear()}
                          className="text-xs"
                        >
                          Hapus Tanda Tangan
                        </Button>
                        <Button
                          variant="danger"
                          size="sm"
                          onClick={() => {
                            // Hapus semua data tersimpan
                            localStorage.removeItem('kuitansi_signature');
                            localStorage.removeItem('kuitansi_recipient_name');
                            localStorage.removeItem('kuitansi_recipient_position');
                            setSignatureData(null);
                            setRecipientName('');
                            setRecipientPosition('');
                            signatureRef.current?.clear();
                            alert('Semua data tanda tangan dan penerima telah dihapus!');
                          }}
                          className="text-xs"
                        >
                          Reset Semua Data
                        </Button>
                        <Button
                          variant="primary"
                          size="sm"
                          onClick={() => {
                            if (signatureRef.current?.isEmpty()) {
                              alert('Silakan buat tanda tangan terlebih dahulu');
                            } else {
                              const dataURL = signatureRef.current.toDataURL();
                              setSignatureData(dataURL);
                              alert('Tanda tangan berhasil disimpan!');
                            }
                          }}
                          className="text-xs"
                        >
                          Simpan Tanda Tangan
                        </Button>
                      </div>
                    </div>
                  </div>
                )}

                {/* Summary Box */}
                {invoiceType && (
                  <div className="mt-2 sm:mt-3 md:mt-4 p-2 sm:p-3 md:p-5 bg-white rounded-lg sm:rounded-xl border-2 border-gray-200 shadow-lg">
                    <h4 className="flex font-bold text-gray-900 mb-2 sm:mb-3 md:mb-4 items-center gap-1.5 sm:gap-2 text-sm sm:text-base md:text-lg">
                      <div className="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                        <svg className="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                      </div>
                      Rincian Pembayaran
                    </h4>
                    
                    {invoiceType === 'dp' && (
                      <div className="space-y-2 sm:space-y-3">
                        {(booking.payment_status === 'DP' || booking.payment_status === 'partial') && booking.amount_paid > 0 && (
                          <div className="flex justify-between items-center p-2 sm:p-3 bg-green-50 rounded-lg border border-green-200">
                            <div>
                              <span className="text-xs sm:text-sm text-gray-700">Sudah Dibayar</span>
                              <span className="text-xs text-green-600 ml-1 sm:ml-2 font-semibold">
                                ({((booking.amount_paid / amounts.total) * 100).toFixed(2).replace('.', ',')}%)
                              </span>
                            </div>
                            <span className="text-sm sm:text-base md:text-lg font-bold text-green-700">Rp {(booking.amount_paid || 0).toLocaleString('id-ID')}</span>
                          </div>
                        )}
                        <div className="flex justify-between items-center p-2 sm:p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                          <div>
                            <span className="text-xs sm:text-sm text-gray-700">Down Payment ({dpPercentage.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 2 })}%)</span>
                            <p className="text-xs text-yellow-600 italic">
                              {(booking.payment_status === 'DP' || booking.payment_status === 'partial') 
                                ? 'Update nominal DP' 
                                : 'DP yang akan dibayar'}
                            </p>
                          </div>
                          <span className="text-sm sm:text-base md:text-lg font-bold text-yellow-700">Rp {Math.round(amounts.dp).toLocaleString('id-ID')}</span>
                        </div>
                        <div className="flex justify-between items-center p-2 sm:p-3 bg-gray-50 rounded-lg">
                          <span className="text-xs sm:text-sm text-gray-700">Sisa Setelah DP</span>
                          <span className="text-sm sm:text-base md:text-lg font-bold text-gray-700">Rp {Math.round(amounts.remaining).toLocaleString('id-ID')}</span>
                        </div>
                        <div className="pt-2 sm:pt-3 border-t-2 border-gray-200">
                          <div className="flex justify-between items-center">
                            <span className="text-xs sm:text-sm font-medium text-gray-600">Total Keseluruhan</span>
                            <span className="text-sm sm:text-base md:text-lg font-bold text-blue-600">Rp {Math.round(amounts.total).toLocaleString('id-ID')}</span>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    {invoiceType === 'pelunasan' && (
                      <div className="space-y-2 sm:space-y-3">
                        <div className="flex justify-between items-center p-2 sm:p-3 bg-green-50 rounded-lg border border-green-200">
                          <div>
                            <span className="text-xs sm:text-sm text-gray-700">Sudah Dibayar</span>
                            <span className="text-xs text-green-600 ml-1 sm:ml-2 font-semibold">
                              ({((booking.amount_paid / amounts.total) * 100).toFixed(2).replace('.', ',')}%)
                            </span>
                          </div>
                          <span className="text-sm sm:text-base md:text-lg font-bold text-green-700">Rp {Math.round(booking.amount_paid || 0).toLocaleString('id-ID')}</span>
                        </div>
                        <div className="flex justify-between items-center p-2 sm:p-3 bg-red-50 rounded-lg border border-red-200">
                          <div>
                            <span className="text-xs sm:text-sm text-gray-700">Sisa Pembayaran</span>
                            <span className="text-xs text-red-600 ml-1 sm:ml-2 font-semibold">
                              ({((amounts.remaining / amounts.total) * 100).toFixed(2).replace('.', ',')}%)
                            </span>
                          </div>
                          <span className="text-sm sm:text-base md:text-lg font-bold text-red-600">Rp {Math.round(amounts.remaining).toLocaleString('id-ID')}</span>
                        </div>
                        <div className="pt-2 sm:pt-3 border-t-2 border-gray-200">
                          <div className="flex justify-between items-center">
                            <span className="text-xs sm:text-sm font-medium text-gray-600">Total Keseluruhan</span>
                            <span className="text-sm sm:text-base md:text-lg font-bold text-blue-600">Rp {Math.round(amounts.total).toLocaleString('id-ID')}</span>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    {/* Removed penuh invoice type display */}
                  </div>
                )}
              </div>

              {/* Invoice Details */}
              <div className="grid grid-cols-3 gap-1.5 sm:gap-2 mt-3 sm:mt-4">
                <div>
                  <label className="flex text-xs font-semibold text-gray-700 mb-0.5 items-center gap-0.5">
                    <svg className="w-2.5 h-2.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                    </svg>
                    Nomor Invoice
                  </label>
                  <input
                    type="text"
                    value={invoiceNumber}
                    onChange={(e) => setInvoiceNumber(e.target.value)}
                    className="w-full px-1.5 py-1 border-2 border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white font-mono text-xs"
                    placeholder="INV-xxxxx"
                  />
                </div>

                <div>
                  <label className="flex text-xs font-semibold text-gray-700 mb-0.5 items-center gap-0.5">
                    <svg className="w-2.5 h-2.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Tanggal Invoice
                  </label>
                  <input
                    type="date"
                    value={invoiceDate}
                    onChange={(e) => setInvoiceDate(e.target.value)}
                    className="w-full px-1.5 py-1 border-2 border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white text-xs"
                  />
                </div>

                <div>
                  <label className="flex text-xs font-semibold text-gray-700 mb-0.5 items-center gap-0.5">
                    <svg className="w-2.5 h-2.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Jatuh Tempo
                  </label>
                  <input
                    type="date"
                    value={dueDate}
                    onChange={(e) => setDueDate(e.target.value)}
                    className="w-full px-1.5 py-1 border-2 border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white text-xs"
                  />
                </div>
              </div>

              {/* Logo Size Control */}
              {companySettings?.company_logo_url && invoiceType && (
                <div className="mt-2 sm:mt-3 p-2 sm:p-3 bg-gray-50 rounded-lg border">
                  <label className="flex text-xs sm:text-sm font-semibold text-gray-700 mb-1.5 sm:mb-2 items-center gap-1.5 sm:gap-2">
                    <svg className="w-3 h-3 sm:w-4 sm:h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span className="text-xs sm:text-sm">Ukuran Logo pada Invoice</span>
                  </label>

                  <div className="flex items-center gap-2 sm:gap-3">
                    <input
                      type="range"
                      min="16"
                      max="80"
                      step="4"
                      value={logoSize}
                      onChange={(e) => setLogoSize(parseInt(e.target.value))}
                      className="flex-1 h-1.5 sm:h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider"
                      style={{
                        background: `linear-gradient(to right, #3b82f6 0%, #3b82f6 ${(logoSize-16)/(80-16)*100}%, #e5e7eb ${(logoSize-16)/(80-16)*100}%, #e5e7eb 100%)`
                      }}
                    />
                    <div className="relative min-w-[50px] sm:min-w-[60px]">
                      <div className="w-12 sm:w-16 px-1.5 sm:px-2 py-0.5 sm:py-1 text-xs sm:text-sm font-bold text-blue-600 text-center bg-white rounded border-2 border-blue-300">
                        {logoSize}px
                      </div>
                    </div>
                  </div>

                  <div className="flex justify-between text-xs text-gray-500 mt-0.5 sm:mt-1">
                    <span className="text-xs">16px</span>
                    <span className="text-xs">80px</span>
                  </div>

                  <p className="text-xs text-gray-600 mt-1 sm:mt-2 italic">
                    Ukuran logo akan diterapkan pada invoice yang didownload
                  </p>
                </div>
              )}
            </div>
          </div>

          {/* Invoice Preview - Visible in Modal */}
          {invoiceType ? (
            <div className="p-2 sm:p-3 md:p-6 bg-gray-50">
              {/* Wrapper for horizontal scroll on mobile */}
              <div className="overflow-x-auto">
                {/* Fixed-width invoice container for consistent PDF/JPEG output */}
                <div 
                  ref={invoiceRef} 
                  className="bg-white mx-auto shadow-lg" 
                  style={{ 
                    fontFamily: "'Times New Roman', Times, serif",
                    width: '595px',  /* A4 width in pixels at 72dpi */
                    minWidth: '595px',
                    padding: '24px',
                    boxSizing: 'border-box'
                  }}
                >
                {/* Header - Company Info & Invoice Title */}
                <div className="flex justify-between items-start mb-4 pb-3 border-b-2 border-gray-300">
                  <div style={{ maxWidth: '280px' }}>
                    {companySettings?.company_logo_url && (
                      <img src={companySettings.company_logo_url} alt="Company Logo" className="mb-2 object-contain" style={{ height: `${logoSize}px`, maxWidth: '150px' }} />
                    )}
                    <h1 style={{ fontSize: '18px', fontWeight: 'bold', color: '#111', marginBottom: '4px' }}>{companySettings?.company_name || 'MOSYA MUSIC'}</h1>
                    {companySettings?.company_address && <p style={{ fontSize: '11px', color: '#555', marginBottom: '2px', lineHeight: '1.4' }}>{companySettings.company_address}</p>}
                    {companySettings?.company_phone && <p style={{ fontSize: '11px', color: '#555', marginBottom: '2px' }}>Kontak: {companySettings.company_phone}</p>}
                    {companySettings?.company_email && <p style={{ fontSize: '11px', color: '#555' }}>Email: {companySettings.company_email}</p>}
                  </div>
                  <div style={{ textAlign: 'right' }}>
                    <h2 style={{ fontSize: '28px', fontWeight: 'bold', color: '#111', marginBottom: '4px' }}>
                      {invoiceType === 'kuitansi' ? 'KUITANSI' : 'INVOICE'}
                    </h2>
                    <p style={{ fontSize: '11px', color: '#555' }}>{invoiceNumber}</p>
                  </div>
                </div>

                {invoiceType === 'kuitansi' ? (
                  /* Kuitansi Layout - Minimalis & Presisi */
                  <>
                    {/* Receipt Content - Clean & Minimal */}
                    <div style={{ marginBottom: '16px' }}>
                      {booking.booking_name && (
                        <h3 style={{ fontSize: '16px', fontWeight: 'bold', color: '#111', marginBottom: '12px', textAlign: 'center' }}>{booking.booking_name}</h3>
                      )}
                      
                      <p style={{ fontSize: '13px', color: '#333', marginBottom: '10px', lineHeight: '1.4' }}>
                        Telah terima dari <strong style={{ color: '#111' }}>{booking.client_name}</strong> uang sebesar:
                      </p>

                      {/* Amount Box - Optimal & Proporsional */}
                      <div style={{ backgroundColor: '#f5f5f5', border: '2px solid #ccc', borderRadius: '6px', padding: '16px', marginBottom: '16px', textAlign: 'center' }}>
                        <p style={{ fontSize: '24px', fontWeight: 'bold', color: '#111', marginBottom: '4px' }}>
                          Rp {Math.round(getInvoiceAmount()).toLocaleString('id-ID')}
                        </p>
                        <p style={{ fontSize: '11px', color: '#666', textTransform: 'capitalize' }}>
                          {numberToWords(Math.round(getInvoiceAmount()))}
                        </p>
                      </div>

                      {/* Service Details - Efisien & Rapi */}
                      <div style={{ border: '1px solid #ccc', borderRadius: '6px', marginBottom: '16px' }}>
                        <div style={{ backgroundColor: '#f9f9f9', padding: '8px 12px', borderBottom: '1px solid #ccc' }}>
                          <p style={{ fontSize: '13px', fontWeight: '600', color: '#111' }}>Rincian Layanan:</p>
                        </div>

                        <div style={{ padding: '12px' }}>
                          {/* Detail Layanan/Jasa */}
                          {amounts.services && amounts.services.length > 0 ? (
                            amounts.services.map((service, index) => {
                              const bookingDays = bookingDetails?.booking_days || 1;
                              const unitPrice = parseFloat(service.custom_price || 0);
                              const quantity = parseInt(service.quantity || 1);
                              const subtotalService = unitPrice * quantity * bookingDays;
                              
                              return (
                                <div key={index} style={{ marginBottom: '10px', paddingBottom: '8px', borderBottom: index === amounts.services.length - 1 ? 'none' : '1px solid #e5e5e5' }}>
                                  <div style={{ fontWeight: '600', color: '#111', fontSize: '12px' }}>{index + 1}. {service.service_name}</div>
                                  <div style={{ marginLeft: '12px', marginTop: '4px', display: 'flex', justifyContent: 'space-between', fontSize: '11px', color: '#555' }}>
                                    <span>@ Rp {Math.round(unitPrice).toLocaleString('id-ID')}
                                      {quantity > 1 && ` × ${quantity}`}
                                      {bookingDays > 1 && ` × ${bookingDays} hari`}
                                    </span>
                                    <span style={{ fontWeight: '600', color: '#111' }}>Rp {Math.round(subtotalService).toLocaleString('id-ID')}</span>
                                  </div>
                                </div>
                              );
                            })
                          ) : (
                            booking.services?.map((service, index) => (
                              <div key={index} style={{ marginBottom: '4px', fontSize: '12px' }}>
                                <span style={{ fontWeight: '600', color: '#111' }}>{index + 1}. {service}</span>
                              </div>
                            ))
                          )}
                          
                          {/* Ringkasan - Optimal */}
                          <div style={{ marginTop: '12px', paddingTop: '10px', borderTop: '1px solid #ccc' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '12px', marginBottom: '4px' }}>
                              <span style={{ color: '#555' }}>Subtotal</span>
                              <span style={{ fontWeight: '600', color: '#111' }}>Rp {Math.round(amounts.servicesSubtotal || 0).toLocaleString('id-ID')}</span>
                            </div>
                            
                            {amounts.discountAmount > 0 && (
                              <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '12px', marginBottom: '4px', color: '#059669' }}>
                                <span>Diskon {amounts.discountType === 'persen' ? `(${amounts.discount}%)` : ''}</span>
                                <span style={{ fontWeight: '600' }}>- Rp {Math.round(amounts.discountAmount).toLocaleString('id-ID')}</span>
                              </div>
                            )}
                            
                            {amounts.additional_fees && amounts.additional_fees.length > 0 && (
                              amounts.additional_fees.map((fee, index) => (
                                <div key={index} style={{ display: 'flex', justifyContent: 'space-between', fontSize: '12px', marginBottom: '4px' }}>
                                  <span style={{ color: '#555' }}>{fee.description || `Biaya Tambahan ${index + 1}`}</span>
                                  <span style={{ fontWeight: '600', color: '#111' }}>Rp {Math.round(parseFloat(fee.amount || 0)).toLocaleString('id-ID')}</span>
                                </div>
                              ))
                            )}
                            
                            {amounts.tax_percentage > 0 && (
                              <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '12px', marginBottom: '4px' }}>
                                <span style={{ color: '#555' }}>Pajak ({amounts.tax_percentage}%)</span>
                                <span style={{ fontWeight: '600', color: '#111' }}>Rp {Math.round(amounts.tax).toLocaleString('id-ID')}</span>
                              </div>
                            )}
                            
                            <div style={{ display: 'flex', justifyContent: 'space-between', paddingTop: '8px', marginTop: '6px', borderTop: '2px solid #888', fontWeight: 'bold', color: '#111', fontSize: '14px' }}>
                              <span>TOTAL</span>
                              <span>Rp {Math.round(amounts.total).toLocaleString('id-ID')}</span>
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* Payment Info - Compact & Presisi */}
                      <div style={{ display: 'flex', gap: '10px', marginBottom: '16px' }}>
                        <div style={{ flex: 1, backgroundColor: '#f9f9f9', border: '1px solid #ccc', borderRadius: '6px', padding: '10px', textAlign: 'center' }}>
                          <p style={{ fontSize: '10px', color: '#666', marginBottom: '4px' }}>Tanggal Pembayaran</p>
                          <p style={{ fontSize: '12px', fontWeight: 'bold', color: '#111' }}>
                            {new Date(kuitansiDate).toLocaleDateString('id-ID', {
                              day: '2-digit',
                              month: 'long',
                              year: 'numeric'
                            })}
                          </p>
                        </div>

                        <div style={{ flex: 1, backgroundColor: '#f9f9f9', border: '1px solid #ccc', borderRadius: '6px', padding: '10px', textAlign: 'center' }}>
                          <p style={{ fontSize: '10px', color: '#666', marginBottom: '4px' }}>Metode Pembayaran</p>
                          <p style={{ fontSize: '12px', fontWeight: 'bold', color: '#111', textTransform: 'capitalize' }}>
                            {paymentMethod === 'cash' ? 'Tunai' : 'Transfer Bank'}
                          </p>
                        </div>
                      </div>

                      {/* Status Badge LUNAS - Simple styling works with html-to-image */}
                      <div style={{ display: 'flex', justifyContent: 'center', alignItems: 'center', padding: '16px 0' }}>
                        <span style={{ display: 'inline-block', backgroundColor: '#dcfce7', color: '#166534', padding: '8px 24px', borderRadius: '20px', border: '2px solid #4ade80', fontSize: '11px', fontWeight: 'bold', letterSpacing: '0.5px' }}>
                          ✓ PEMBAYARAN LUNAS
                        </span>
                      </div>
                    </div>

                    {/* Signature Section - Professional & Rapi */}
                    <div style={{ borderTop: '1px solid #ccc', paddingTop: '16px' }}>
                      <div style={{ textAlign: 'center' }}>
                        <p style={{ fontSize: '13px', fontWeight: '600', color: '#333', marginBottom: '10px' }}>Penerima,</p>

                        <div style={{ width: '100%', maxWidth: '200px', margin: '0 auto' }}>
                          {/* Signature Image */}
                          {signatureData ? (
                            <div style={{ marginBottom: '8px' }}>
                              <img
                                src={signatureData}
                                alt="Tanda Tangan Digital"
                                style={{ width: '120px', height: '50px', objectFit: 'contain', margin: '0 auto', display: 'block' }}
                              />
                            </div>
                          ) : (
                            <div style={{ width: '120px', height: '30px', margin: '0 auto 8px' }}></div>
                          )}

                          {/* Name and Position - Always show as text for consistent rendering */}
                          <div>
                            <div style={{ textAlign: 'center', borderBottom: '2px solid #333', paddingBottom: '4px', marginBottom: '4px' }}>
                              <span style={{ fontSize: '12px', fontWeight: 'bold', color: '#111' }}>
                                {recipientName || 'Nama Penerima'}
                              </span>
                            </div>
                            <div style={{ textAlign: 'center' }}>
                              <span style={{ fontSize: '10px', color: '#555', fontStyle: 'italic' }}>
                                {recipientPosition || 'Jabatan'}
                              </span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </>
                ) : (
                  /* Invoice Layout - Detailed with Inline Styles for PDF/JPEG Export */
                  <>
                    {/* Bill To & Date Info - Side by Side */}
                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '20px', gap: '10px' }}>
                      <div style={{ flex: '1', minWidth: '0' }}>
                        {booking.booking_name && (
                          <h3 style={{ fontSize: '14px', fontWeight: 'bold', color: '#111', marginBottom: '8px' }}>{booking.booking_name}</h3>
                        )}
                        <h3 style={{ fontSize: '11px', fontWeight: 'bold', color: '#111', marginBottom: '6px' }}>Bill To:</h3>
                        <p style={{ fontSize: '12px', fontWeight: 'bold', color: '#111', margin: '0 0 2px 0' }}>{booking.client_name}</p>
                        <p style={{ fontSize: '11px', color: '#555', margin: 0 }}>{formatPhoneNumber(booking.contact)}</p>
                      </div>
                      
                      {/* Date Information - Right Side */}
                      <div style={{ flex: '1', minWidth: '0', textAlign: 'right', fontSize: '10px' }}>
                        <div style={{ display: 'grid', gridTemplateColumns: 'auto auto', gap: '2px 8px', justifyContent: 'end' }}>
                          <span style={{ color: '#555' }}>Tanggal Invoice:</span>
                          <span style={{ fontWeight: 'bold', color: '#111' }}>{new Date(invoiceDate).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}</span>
                          
                          <span style={{ color: '#555' }}>Jatuh Tempo:</span>
                          <span style={{ fontWeight: 'bold', color: '#111' }}>{new Date(dueDate).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })}</span>
                          
                          <span style={{ color: '#555' }}>Layanan Mulai:</span>
                          <span style={{ fontWeight: 'bold', color: '#111' }}>{new Date(booking.booking_date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })} - {bookingDetails?.booking_time || booking.booking_time || '08:15'}</span>
                          
                          <span style={{ color: '#555' }}>Selesai:</span>
                          <span style={{ fontWeight: 'bold', color: '#111' }}>{bookingDetails?.booking_date_end ? new Date(bookingDetails.booking_date_end).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' }) : new Date(booking.booking_date).toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })} - {bookingDetails?.booking_time_end || booking.booking_time_end || '09:15'}</span>
                        </div>
                      </div>
                    </div>

                    {/* Invoice Items Table - Optimized for 595px width */}
                    <table style={{ width: '100%', marginBottom: '16px', borderCollapse: 'collapse', fontFamily: "'Times New Roman', Times, serif", tableLayout: 'fixed' }}>
                      <thead style={{ backgroundColor: '#fff', borderBottom: '2px solid #111' }}>
                        <tr>
                          <th style={{ width: '35%', textAlign: 'left', padding: '6px 4px', fontSize: '10px', fontWeight: 'bold', color: '#111' }}>Deskripsi Layanan</th>
                          <th style={{ width: '15%', textAlign: 'center', padding: '6px 4px', fontSize: '9px', fontWeight: 'bold', color: '#111' }}>Mulai</th>
                          <th style={{ width: '15%', textAlign: 'center', padding: '6px 4px', fontSize: '9px', fontWeight: 'bold', color: '#111' }}>Selesai</th>
                          <th style={{ width: '17%', textAlign: 'right', padding: '6px 4px', fontSize: '10px', fontWeight: 'bold', color: '#111' }}>Harga</th>
                          <th style={{ width: '18%', textAlign: 'right', padding: '6px 4px', fontSize: '10px', fontWeight: 'bold', color: '#111' }}>Jumlah</th>
                        </tr>
                      </thead>
                      <tbody>
                        {amounts.services && amounts.services.length > 0 ? (
                          amounts.services.map((service, index) => {
                            const details = booking.booking_details;
                            const bookingDays = details?.booking_days || 1;
                            const hasEndDate = details?.booking_date_end;
                            
                            // Prioritas pengambilan waktu mulai: booking_details > booking table > fallback
                            let startTime = '09:00';
                            if (details?.booking_time) {
                              startTime = details.booking_time;
                            } else if (booking.booking_time) {
                              startTime = booking.booking_time;
                            }
                            
                            // Prioritas pengambilan waktu selesai
                            let endTime = '17:00';
                            if (details?.booking_time_end) {
                              endTime = details.booking_time_end;
                            } else if (booking.booking_time_end) {
                              endTime = booking.booking_time_end;
                            }
                            
                            return (
                              <tr key={index} style={{ borderBottom: '1px solid #ddd' }}>
                                <td style={{ padding: '6px 4px', fontSize: '10px', color: '#111', verticalAlign: 'top' }}>
                                  {service.service_name}
                                  {service.quantity > 1 && <span style={{ marginLeft: '4px', color: '#16a34a', fontWeight: '600', fontSize: '9px' }}>(x{service.quantity})</span>}
                                  {bookingDays > 1 && <span style={{ marginLeft: '4px', color: '#2563eb', fontWeight: '600', fontSize: '9px' }}>x{bookingDays} hari</span>}
                                </td>
                                <td style={{ padding: '6px 4px', fontSize: '9px', color: '#555', textAlign: 'center', verticalAlign: 'top' }}>
                                  {new Date(booking.booking_date).toLocaleDateString('id-ID')}<br/>
                                  <span style={{ fontWeight: '600' }}>{startTime}</span>
                                </td>
                                <td style={{ padding: '6px 4px', fontSize: '9px', color: '#555', textAlign: 'center', verticalAlign: 'top' }}>
                                  {hasEndDate ? (
                                    <>
                                      {new Date(details.booking_date_end).toLocaleDateString('id-ID')}<br/>
                                      <span style={{ fontWeight: '600' }}>{endTime}</span>
                                    </>
                                  ) : (
                                    <>
                                      {new Date(booking.booking_date).toLocaleDateString('id-ID')}<br/>
                                      <span style={{ fontWeight: '600' }}>{endTime}</span>
                                    </>
                                  )}
                                </td>
                                <td style={{ padding: '6px 4px', fontSize: '10px', color: '#111', textAlign: 'right', verticalAlign: 'top' }}>
                                  Rp {Math.round(service.custom_price || 0).toLocaleString('id-ID')}
                                </td>
                                <td style={{ padding: '6px 4px', fontSize: '10px', color: '#111', textAlign: 'right', verticalAlign: 'top' }}>
                                  Rp {Math.round((service.custom_price || 0) * (service.quantity || 1) * bookingDays).toLocaleString('id-ID')}
                                  {(service.quantity > 1 || bookingDays > 1) && (
                                    <div style={{ fontSize: '8px', color: '#777', marginTop: '2px' }}>
                                      ({service.quantity || 1} x Rp {Math.round(service.custom_price || 0).toLocaleString('id-ID')} x {bookingDays} hari)
                                    </div>
                                  )}
                                </td>
                              </tr>
                            );
                          })
                        ) : (
                          booking.services?.map((service, index) => {
                            const details = booking.booking_details;
                            const bookingDays = details?.booking_days || 1;
                            const hasEndDate = details?.booking_date_end;
                            
                            // Prioritas pengambilan waktu mulai: booking_details > booking table > fallback
                            let startTime = '09:00';
                            if (details?.booking_time) {
                              startTime = details.booking_time;
                            } else if (booking.booking_time) {
                              startTime = booking.booking_time;
                            }
                            
                            // Prioritas pengambilan waktu selesai
                            let endTime = '17:00';
                            if (details?.booking_time_end) {
                              endTime = details.booking_time_end;
                            } else if (booking.booking_time_end) {
                              endTime = booking.booking_time_end;
                            }
                            return (
                              <tr key={index} style={{ borderBottom: '1px solid #ddd' }}>
                                <td style={{ padding: '6px 4px', fontSize: '10px', color: '#111', verticalAlign: 'top' }}>
                                  {service}
                                  {bookingDays > 1 && <span style={{ marginLeft: '4px', color: '#2563eb', fontWeight: '600', fontSize: '9px' }}>x{bookingDays}</span>}
                                </td>
                                <td style={{ padding: '6px 4px', fontSize: '9px', color: '#555', textAlign: 'center', verticalAlign: 'top' }}>
                                  {new Date(booking.booking_date).toLocaleDateString('id-ID')}<br/>
                                  <span style={{ fontWeight: '600' }}>{startTime}</span>
                                </td>
                                <td style={{ padding: '6px 4px', fontSize: '9px', color: '#555', textAlign: 'center', verticalAlign: 'top' }}>
                                  {hasEndDate ? (
                                    <>
                                      {new Date(details.booking_date_end).toLocaleDateString('id-ID')}<br/>
                                      <span style={{ fontWeight: '600' }}>{endTime}</span>
                                    </>
                                  ) : (
                                    <>
                                      {new Date(booking.booking_date).toLocaleDateString('id-ID')}<br/>
                                      <span style={{ fontWeight: '600' }}>{endTime}</span>
                                    </>
                                  )}
                                </td>
                                <td style={{ padding: '6px 4px', fontSize: '10px', color: '#111', textAlign: 'right', verticalAlign: 'top' }}>
                                  Rp {Math.round((booking.total_amount || 0) / bookingDays).toLocaleString('id-ID')}
                                </td>
                                <td style={{ padding: '6px 4px', fontSize: '10px', color: '#111', textAlign: 'right', verticalAlign: 'top' }}>
                                  Rp {Math.round(booking.total_amount || 0).toLocaleString('id-ID')}
                                  {bookingDays > 1 && <div style={{ fontSize: '8px', color: '#777', marginTop: '2px' }}>(Rp {Math.round((booking.total_amount || 0) / bookingDays).toLocaleString('id-ID')} x {bookingDays} hari)</div>}
                                </td>
                              </tr>
                            );
                          })
                        )}
                        
                        {/* Additional Fees */}
                        {amounts.additional_fees && amounts.additional_fees.length > 0 && amounts.additional_fees.map((fee, index) => (
                          <tr key={`fee-${index}`} style={{ borderBottom: '1px solid #ddd' }}>
                            <td style={{ padding: '6px 4px', fontSize: '10px', color: '#111' }}>{fee.description}</td>
                            <td style={{ padding: '6px 4px', fontSize: '9px', color: '#777', textAlign: 'center' }}>-</td>
                            <td style={{ padding: '6px 4px', fontSize: '9px', color: '#777', textAlign: 'center' }}>-</td>
                            <td style={{ padding: '6px 4px', fontSize: '10px', color: '#111', textAlign: 'right' }}>Rp {Math.round(fee.amount).toLocaleString('id-ID')}</td>
                            <td style={{ padding: '6px 4px', fontSize: '10px', color: '#111', textAlign: 'right' }}></td>
                          </tr>
                        ))}
                      </tbody>
                    </table>

                    {/* Totals - Summary Box */}
                    <div style={{ display: 'flex', justifyContent: 'flex-end', marginBottom: '16px' }}>
                      <div style={{ backgroundColor: '#f9f9f9', border: '1px solid #ccc', borderRadius: '6px', padding: '12px', minWidth: '240px' }}>
                        <div style={{ fontSize: '11px' }}>
                          {/* Services Subtotal */}
                          <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '6px' }}>
                            <span style={{ color: '#555' }}>Subtotal Layanan:</span>
                            <span style={{ fontWeight: 'bold', color: '#111' }}>Rp {Math.round(amounts.servicesSubtotal).toLocaleString('id-ID')}</span>
                          </div>
                          
                          {/* Discount */}
                          {amounts.discountAmount > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '6px' }}>
                              <span style={{ color: '#555' }}>Diskon ({amounts.discountType === 'persen' ? `${amounts.discount}%` : ''}):</span>
                              <span style={{ fontWeight: 'bold', color: '#16a34a' }}>-Rp {Math.round(amounts.discountAmount).toLocaleString('id-ID')}</span>
                            </div>
                          )}
                          
                          {/* Tax */}
                          {amounts.tax_percentage > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '6px' }}>
                              <span style={{ color: '#555' }}>PPN ({amounts.tax_percentage}%):</span>
                              <span style={{ fontWeight: 'bold', color: '#111' }}>Rp {Math.round(amounts.tax).toLocaleString('id-ID')}</span>
                            </div>
                          )}
                          
                          {/* Additional Fees Total */}
                          {amounts.additional_fees && amounts.additional_fees.length > 0 && (
                            <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '6px' }}>
                              <span style={{ color: '#555' }}>Biaya Tambahan:</span>
                              <span style={{ fontWeight: 'bold', color: '#111' }}>Rp {Math.round(amounts.additional_fees.reduce((sum, fee) => sum + parseFloat(fee.amount || 0), 0)).toLocaleString('id-ID')}</span>
                            </div>
                          )}
                          
                          {/* Grand Total */}
                          <div style={{ display: 'flex', justifyContent: 'space-between', borderTop: '2px solid #888', paddingTop: '8px', marginTop: '8px' }}>
                            <span style={{ color: '#111', fontWeight: 'bold', fontSize: '11px' }}>TOTAL<br/>KESELURUHAN:</span>
                            <span style={{ color: '#2563eb', fontWeight: 'bold', fontSize: '14px' }}>Rp {Math.round(amounts.total).toLocaleString('id-ID')}</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Payment Info - Minimalist Layout */}
                    {companySettings?.bank_name && (
                      <div style={{ marginTop: '16px' }}>
                        <div style={{ border: '1px solid #ccc', borderRadius: '6px', padding: '12px' }}>
                          <h3 style={{ fontSize: '12px', fontWeight: 'bold', color: '#111', marginBottom: '10px' }}>Informasi Pembayaran</h3>
                          
                          <div style={{ fontSize: '11px', marginBottom: '10px' }}>
                            <div style={{ marginBottom: '2px' }}>
                              <span style={{ color: '#555' }}>Status: </span>
                              <span style={{ fontWeight: 'bold', color: '#111' }}>
                                {invoiceType === 'dp' ? 'Down Payment' : invoiceType === 'pelunasan' ? 'Pelunasan' : invoiceType === 'penuh' ? 'Lunas' : invoiceType === 'kuitansi' ? 'Diterima' : 'Lunas'}
                              </span>
                            </div>
                            <div>
                              <span style={{ color: '#555' }}>Sudah Dibayar: </span>
                              <span style={{ fontWeight: 'bold', color: '#111' }}>
                                Rp {Math.round(booking.amount_paid || 0).toLocaleString('id-ID')}
                              </span>
                            </div>
                          </div>

                          {/* Total Pembayaran Box */}
                          <div style={{ backgroundColor: '#fff7ed', border: '1px solid #fb923c', borderRadius: '6px', padding: '10px', textAlign: 'center', marginBottom: '12px' }}>
                            <p style={{ fontSize: '11px', color: '#555', marginBottom: '4px' }}>Total Pembayaran</p>
                            <p style={{ fontSize: '18px', fontWeight: 'bold', color: '#ea580c', margin: 0 }}>
                              Rp {Math.round(getInvoiceAmount()).toLocaleString('id-ID')}
                            </p>
                          </div>

                          {/* Transfer Bank - Minimalist Table */}
                          <div>
                            <h4 style={{ fontSize: '11px', fontWeight: 'bold', color: '#111', marginBottom: '8px' }}>Transfer Bank:</h4>
                            <table style={{ width: '100%', fontSize: '11px' }}>
                              <tbody>
                                {companySettings.bank_name && (
                                  <tr>
                                    <td style={{ padding: '3px 0', color: '#555' }}>Bank:</td>
                                    <td style={{ padding: '3px 0', fontWeight: 'bold', color: '#111', textAlign: 'right' }}>{companySettings.bank_name}</td>
                                  </tr>
                                )}
                                {companySettings.account_number && (
                                  <tr>
                                    <td style={{ padding: '3px 0', color: '#555' }}>No. Rekening:</td>
                                    <td style={{ padding: '3px 0', fontWeight: 'bold', color: '#111', textAlign: 'right' }}>{companySettings.account_number}</td>
                                  </tr>
                                )}
                                {companySettings.account_holder_name && (
                                  <tr>
                                    <td style={{ padding: '3px 0', color: '#555' }}>A.n:</td>
                                    <td style={{ padding: '3px 0', fontWeight: 'bold', color: '#111', textAlign: 'right' }}>{companySettings.account_holder_name}</td>
                                  </tr>
                                )}
                              </tbody>
                            </table>
                          </div>
                        </div>

                        {/* Instructions */}
                        <div style={{ backgroundColor: '#fff7ed', border: '1px solid #fb923c', borderRadius: '6px', padding: '10px', marginTop: '10px' }}>
                          <h4 style={{ fontSize: '11px', fontWeight: 'bold', color: '#111', marginBottom: '4px' }}>Instruksi Pembayaran:</h4>
                          <p style={{ fontSize: '10px', color: '#555', margin: 0 }}>
                            {companySettings?.payment_instructions || 'Silakan transfer ke rekening di atas dan kirimkan bukti transfer untuk konfirmasi pembayaran.'}
                          </p>
                        </div>
                      </div>
                    )}
                  </>
                )}
                </div>
              </div>

              {/* Action Buttons */}
              <div className="flex gap-3 mt-4 p-4 bg-white border-t border-gray-200">
                <Button
                  onClick={() => {
                    // Auto-save current invoice display state before closing
                    if (invoiceType) {
                      const displayData = {
                        invoiceType,
                        dpPercentage,
                        dpAmount: parseFloat(dpInputValue.replace(/[^\d]/g, '')) || 0,
                        remainingAmount: amounts.remaining,
                        totalPrice: amounts.total
                      };
                      localStorage.setItem(`invoice_display_${booking.id}`, JSON.stringify(displayData));
                    }
                    onClose();
                  }}
                  variant="outline"
                  className="flex-1"
                >
                  Kembali
                </Button>
                {invoiceType && (
                  <Button
                    onClick={handleInvoicePaid}
                    disabled={isSaving}
                    className="flex-1 bg-green-600 hover:bg-green-700 disabled:opacity-50"
                  >
                    {isSaving ? 'Menyimpan...' : 'Invoice Dibayar'}
                  </Button>
                )}
              </div>
            </div>
          ) : (
            /* Instruction Section when no invoice type is selected */
            <div className="p-2 sm:p-3 md:p-4 bg-gray-50">
              <div className="text-center py-8">
                <div className="mb-4">
                  <svg className="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                </div>
                <h3 className="text-lg font-medium text-gray-900 mb-2">Pilih Tipe Invoice</h3>
                <p className="text-sm text-gray-500">
                  Silakan pilih tipe invoice yang ingin Anda generate dari tombol-tombol di atas.
                </p>
              </div>
            </div>
          )}
        </div>

        {/* Download Modal */}
        {showDownloadModal && (
          <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] p-4">
            <div className="bg-white rounded-lg sm:rounded-xl shadow-2xl w-full max-w-md p-4 sm:p-6">
              <h3 className="text-lg sm:text-xl font-bold text-gray-900 mb-3 sm:mb-4">Download Invoice</h3>
              
              <div className="mb-3 sm:mb-4">
                <label className="block text-xs sm:text-sm font-semibold text-gray-700 mb-1 sm:mb-2">
                  Nama File:
                </label>
                <input
                  type="text"
                  value={fileName}
                  onChange={(e) => setFileName(e.target.value)}
                  className="w-full px-3 sm:px-4 py-2 sm:py-2.5 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                  placeholder="Masukkan nama file"
                />
                <p className="text-xs text-gray-500 mt-1">
                  File akan disimpan sebagai: <span className="font-semibold">{fileName}.{downloadFormat === 'pdf' ? 'pdf' : 'jpg'}</span>
                </p>
              </div>

              <div className="mb-4 sm:mb-6">
                <label className="block text-xs sm:text-sm font-semibold text-gray-700 mb-2">
                  Format Download:
                </label>
                <div className="flex gap-3 sm:gap-4">
                  <label className="flex items-center">
                    <input
                      type="radio"
                      value="pdf"
                      checked={downloadFormat === 'pdf'}
                      onChange={(e) => setDownloadFormat(e.target.value)}
                      className="mr-2"
                    />
                    <span className="text-sm">PDF</span>
                  </label>
                  <label className="flex items-center">
                    <input
                      type="radio"
                      value="jpg"
                      checked={downloadFormat === 'jpg'}
                      onChange={(e) => setDownloadFormat(e.target.value)}
                      className="mr-2"
                    />
                    <span className="text-sm">JPG</span>
                  </label>
                </div>
              </div>

              <div className="flex gap-3">
                <Button
                  onClick={() => setShowDownloadModal(false)}
                  variant="outline"
                  className="flex-1"
                >
                  Batal
                </Button>
                <Button
                  onClick={executeDownload}
                  className="flex-1 bg-blue-600 hover:bg-blue-700"
                  disabled={!fileName.trim()}
                >
                  Download
                </Button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default GenerateInvoiceModal;
