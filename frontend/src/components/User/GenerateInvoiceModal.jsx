import React, { useState, useEffect, useRef } from 'react';
import { FiX, FiDownload, FiInfo } from 'react-icons/fi';
import Button from '../Common/Button';
import api from '../../services/api';
import html2canvas from 'html2canvas';
import jsPDF from 'jspdf';

const GenerateInvoiceModal = ({ isOpen, onClose, booking, onSave }) => {
  const [invoiceType, setInvoiceType] = useState('');
  const [invoiceNumber, setInvoiceNumber] = useState('');
  const [invoiceDate, setInvoiceDate] = useState(new Date().toISOString().split('T')[0]);
  const [dueDate, setDueDate] = useState('');
  const [dpPercentage, setDpPercentage] = useState(30);
  const [companySettings, setCompanySettings] = useState(null);
  const [dpInputValue, setDpInputValue] = useState('');
  const [isSaving, setIsSaving] = useState(false);
  const [showDownloadModal, setShowDownloadModal] = useState(false);
  const [downloadFormat, setDownloadFormat] = useState('pdf');
  const [fileName, setFileName] = useState('');
  const invoiceRef = useRef(null);
  const autoGeneratedInvoiceRef = useRef(false);

  // Helper: build invoice number string for a given date and counter
  const buildInvoiceNumber = (dateObj, counter) => {
    const day = String(dateObj.getDate()).padStart(2, '0');
    const month = String(dateObj.getMonth() + 1).padStart(2, '0');
    const year = dateObj.getFullYear();
    const dateStr = `${day}${month}${year}`;
    const counterStr = String(counter).padStart(4, '0');
    return `INV-${dateStr}-${counterStr}`;
  };

  // Peek next invoice number for today without incrementing counter in localStorage
  const peekNextInvoiceNumber = () => {
    const today = new Date();
    const day = String(today.getDate()).padStart(2, '0');
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const year = today.getFullYear();
    const dateStr = `${day}${month}${year}`;
    const counterKey = `invoice_counter_${dateStr}`;
    const current = parseInt(localStorage.getItem(counterKey) || '0');
    const next = current + 1;
    return buildInvoiceNumber(today, next);
  };

  // Increment and persist the invoice counter for a given date (used when saving)
  const persistInvoiceCounterForNumber = (invNumber) => {
    if (!invNumber || typeof invNumber !== 'string') return;
    // Expect format INV-DDMMYYYY-CCCC
    const parts = invNumber.split('-');
    if (parts.length < 3) return;
    const dateStr = parts[1];
    const counterStr = parts[2];
    const counter = parseInt(counterStr) || 0;
    if (!dateStr) return;
    const counterKey = `invoice_counter_${dateStr}`;
    const existing = parseInt(localStorage.getItem(counterKey) || '0');
    // Only update if counter is greater than existing
    if (counter > existing) {
      localStorage.setItem(counterKey, String(counter));
    }
  };

  useEffect(() => {
    if (isOpen && booking) {
      console.log('=== BOOKING DATA RECEIVED ===');
      console.log('Full booking object:', JSON.stringify(booking, null, 2));
      console.log('booking.booking_date:', booking.booking_date);
      console.log('booking.booking_time:', booking.booking_time);
      console.log('booking.booking_time_end:', booking.booking_time_end);
      console.log('booking.booking_details:', booking.booking_details);
      console.log('booking.notes:', booking.notes);
      
      if (booking.booking_details) {
        console.log('booking_details.booking_time:', booking.booking_details.booking_time);
        console.log('booking_details.booking_time_end:', booking.booking_details.booking_time_end);
        console.log('booking_details.booking_date:', booking.booking_details.booking_date);
        console.log('booking_details.booking_date_end:', booking.booking_details.booking_date_end);
      }
      
      // Try to parse booking_details from notes if not already parsed
      if (!booking.booking_details && booking.notes) {
        try {
          const parsedDetails = JSON.parse(booking.notes);
          booking.booking_details = parsedDetails;
          console.log('Parsed booking_details from notes:', parsedDetails);
        } catch (e) {
          console.log('Notes is not JSON format, treating as plain text');
        }
      }
      
      console.log('============================');
      
      // Check if invoice number already exists in booking details
      let invNumber = '';
      let savedInvoiceType = '';
      let savedDpPercentage = 30;
      let savedDpAmount = 0;
      
      if (booking.booking_details && booking.booking_details.invoice_number) {
        invNumber = booking.booking_details.invoice_number;
        console.log('Using existing invoice number:', invNumber);
        autoGeneratedInvoiceRef.current = false;
        
        // Restore saved invoice type and DP settings
        if (booking.booking_details.invoice_type) {
          savedInvoiceType = booking.booking_details.invoice_type;
          console.log('Restoring saved invoice type:', savedInvoiceType);
        }
        
        if (booking.booking_details.dp_percentage) {
          savedDpPercentage = booking.booking_details.dp_percentage;
          console.log('Restoring saved DP percentage:', savedDpPercentage);
        }
        
        if (booking.booking_details.dp_amount) {
          savedDpAmount = booking.booking_details.dp_amount;
          console.log('Restoring saved DP amount:', savedDpAmount);
        }
      } else {
        // Peek next invoice number (do NOT persist yet)
        invNumber = peekNextInvoiceNumber();
        console.log('Peeked new invoice number (not persisted):', invNumber);
        autoGeneratedInvoiceRef.current = true;
      }
      setInvoiceNumber(invNumber);
      setInvoiceType(savedInvoiceType);
      setDpPercentage(savedDpPercentage);
      
      if (savedDpAmount > 0) {
        setDpInputValue(savedDpAmount.toLocaleString('id-ID'));
      }

      const due = new Date();
      due.setDate(due.getDate() + 30);
      setDueDate(due.toISOString().split('T')[0]);

      // Set invoice type based on payment status (primary logic)
      let finalInvoiceType = '';

      // Priority 1: Payment status determines available invoice types
      if (booking.payment_status === 'Lunas' || booking.payment_status === 'paid') {
        // Status sudah lunas, hanya bisa invoice penuh
        finalInvoiceType = 'penuh';
      } else if (booking.payment_status === 'DP' || booking.payment_status === 'partial') {
        // Status sudah DP, hanya bisa invoice pelunasan
        finalInvoiceType = 'pelunasan';
      } else {
        // Status belum bayar, gunakan saved invoice type jika ada
        if (savedInvoiceType) {
          finalInvoiceType = savedInvoiceType;
        } else {
          finalInvoiceType = '';
        }
      }

      setInvoiceType(finalInvoiceType);

      // Set DP input value based on saved data or existing payment
      if (savedDpAmount > 0) {
        setDpInputValue(savedDpAmount.toLocaleString('id-ID'));
      } else if (booking.amount_paid > 0) {
        setDpInputValue(booking.amount_paid.toLocaleString('id-ID'));
        const percentage = (booking.amount_paid / (booking.total_amount * 1.02)) * 100;
        setDpPercentage(parseFloat(percentage.toFixed(2)));
      } else {
        setDpInputValue('');
      }

      fetchCompanySettings();
    }
  }, [isOpen, booking]);

  const fetchCompanySettings = async () => {
    try {
      const response = await api.get('/user/company-settings');
      if (response.data.success && response.data.data) {
        console.log('=== COMPANY SETTINGS DEBUG ===');
        console.log('Company Settings Data:', response.data.data);
        console.log('Bank 1 - Name:', response.data.data.bank_name);
        console.log('Bank 1 - Account Number:', response.data.data.account_number);
        console.log('Bank 1 - Account Holder:', response.data.data.account_holder_name);
        console.log('Bank 2 - Name:', response.data.data.bank_name_alt);
        console.log('Bank 2 - Account Number:', response.data.data.account_number_alt);
        console.log('Bank 2 - Account Holder:', response.data.data.account_holder_name_alt);
        console.log('============================');
        setCompanySettings(response.data.data);
      }
    } catch (error) {
      console.error('Error fetching company settings:', error);
    }
  };

  const calculateInvoiceAmounts = () => {
    if (!booking) return { 
      subtotal: 0, 
      dp: 0, 
      remaining: 0, 
      total: 0, 
      tax: 0, 
      alreadyPaid: 0,
      discount: 0,
      services: [],
      additional_fees: [],
      tax_percentage: 0
    };

    // Parse booking details if available
    let bookingDetails = booking.booking_details;
    const bookingDays = bookingDetails?.booking_days || 1;
    
    // Calculate subtotal from services or use total_amount
    let servicesSubtotal = 0;
    let servicesList = [];
    
    if (bookingDetails && bookingDetails.services && bookingDetails.services.length > 0) {
      // New format: use booking_details
      servicesList = bookingDetails.services;
      servicesSubtotal = bookingDetails.services.reduce((sum, service) => {
        const price = parseFloat(service.custom_price || 0);
        const quantity = parseInt(service.quantity) || 1;
        return sum + (price * quantity);
      }, 0);
      // Multiply by booking days
      servicesSubtotal = servicesSubtotal * bookingDays;
    } else if (booking.services && booking.services.length > 0) {
      // Legacy format: create service list from booking.services (service names only)
      // Use total_amount as price since we don't have individual prices
      servicesList = booking.services.map(serviceName => ({
        service_name: serviceName,
        custom_price: parseFloat(booking.total_amount)
      }));
      servicesSubtotal = parseFloat(booking.total_amount);
    } else {
      // Fallback: no services data
      servicesSubtotal = parseFloat(booking.total_amount);
    }
    
    // Get discount and additional fees from booking details
    const discount = bookingDetails?.discount || 0;
    const discountType = bookingDetails?.discount_type || 'rupiah'; // Ambil tipe diskon
    const additional_fees = bookingDetails?.additional_fees || [];
    const tax_percentage = bookingDetails?.tax_percentage || 0;
    
    // Calculate additional fees total
    const additionalFeesTotal = additional_fees.reduce((sum, fee) => {
      return sum + parseFloat(fee.amount || 0);
    }, 0);
    
    // Calculate discount amount based on type
    let discountAmount = 0;
    if (discount > 0) {
      if (discountType === 'persen') {
        discountAmount = (servicesSubtotal * discount) / 100;
      } else {
        discountAmount = discount;
      }
    }
    
    // Calculate subtotal after discount
    const subtotalAfterDiscount = servicesSubtotal - discountAmount;
    
    // Calculate tax
    const tax = (subtotalAfterDiscount * tax_percentage) / 100;
    
    // Calculate final total
    const total = subtotalAfterDiscount + tax + additionalFeesTotal;
    
    // Gunakan nilai dari input manual jika ada, jika tidak gunakan perhitungan dari percentage
    let dpAmount = (total * dpPercentage) / 100;
    if (dpInputValue && invoiceType === 'dp') {
      const manualValue = parseFloat(dpInputValue.replace(/\./g, ''));
      if (!isNaN(manualValue) && manualValue > 0) {
        dpAmount = manualValue;
      }
    }
    
    // alreadyPaid = yang sudah dibayar sebelumnya (tidak berubah di UI)
    // remaining = sisa setelah DP baru (untuk preview)
    const alreadyPaid = booking.amount_paid || 0;
    let remaining = total - dpAmount; // Sisa dihitung dari DP baru
    
    if (invoiceType === 'pelunasan') {
      // Untuk pelunasan, remaining adalah sisa setelah amount_paid
      remaining = total - alreadyPaid;
    }

    return {
      subtotal: subtotalAfterDiscount, // Subtotal setelah diskon
      servicesSubtotal, // Total layanan murni untuk tabel
      subtotalAfterDiscount,
      dp: dpAmount,
      remaining,
      total,
      tax,
      discount,
      discountAmount, // Tambahkan discountAmount
      discountType, // Tambahkan discountType
      alreadyPaid,
      services: servicesList,
      additional_fees,
      additionalFeesTotal,
      tax_percentage
    };
  };

  const amounts = calculateInvoiceAmounts();
  
  // Define bookingDetails at component level for use in JSX
  const bookingDetails = booking?.booking_details;
  
  // Helper function to format phone number: add +62 prefix with space
  const formatPhoneNumber = (phone) => {
    if (!phone) return '';
    // Remove all spaces and special characters except numbers
    const cleaned = phone.replace(/[^\d]/g, '');
    // If starts with 62, add +62 and space
    if (cleaned.startsWith('62')) {
      return `+62 ${cleaned.substring(2)}`;
    }
    // If starts with 0, replace with +62 and space
    if (cleaned.startsWith('0')) {
      return `+62 ${cleaned.substring(1)}`;
    }
    // Otherwise, add +62 and space
    return `+62 ${cleaned}`;
  };
  
  // Debug log amounts
  if (isOpen && booking) {
    console.log('=== CALCULATED AMOUNTS ===');
    console.log('Services:', amounts.services);
    console.log('Subtotal:', amounts.subtotal);
    console.log('Discount:', amounts.discount);
    console.log('Subtotal After Discount:', amounts.subtotalAfterDiscount);
    console.log('Tax %:', amounts.tax_percentage);
    console.log('Tax Amount:', amounts.tax);
    console.log('Additional Fees:', amounts.additional_fees);
    console.log('Additional Fees Total:', amounts.additionalFeesTotal);
    console.log('GRAND TOTAL:', amounts.total);
    console.log('==========================');
  }

  const getInvoiceAmount = () => {
    switch (invoiceType) {
      case 'dp':
        return amounts.dp;
      case 'pelunasan':
        return amounts.remaining;
      case 'penuh':
        return amounts.total;
      default:
        return 0;
    }
  };

  const handleSaveInvoice = async () => {
    try {
      setIsSaving(true);
      
      let newPaymentStatus = booking.payment_status;
      let newAmountPaid = booking.amount_paid || 0;

      if (invoiceType === 'dp') {
        newPaymentStatus = 'partial';
        newAmountPaid = amounts.dp;
      } else if (invoiceType === 'pelunasan') {
        newPaymentStatus = 'paid';
        newAmountPaid = amounts.total;
      } else if (invoiceType === 'penuh') {
        newPaymentStatus = 'paid';
        newAmountPaid = amounts.total;
      }

      // Convert payment status to English for backend (database constraint) - update after newPaymentStatus is set
      let backendPaymentStatus = 'unpaid'; // default
      if (newPaymentStatus === 'Lunas' || newPaymentStatus === 'paid') {
        backendPaymentStatus = 'paid';
      } else if (newPaymentStatus === 'DP' || newPaymentStatus === 'partial') {
        backendPaymentStatus = 'partial';
      } else if (newPaymentStatus === 'Belum Bayar' || newPaymentStatus === 'unpaid') {
        backendPaymentStatus = 'unpaid';
      } else {
        // If status is already in English format, use it
        const validStatuses = ['paid', 'partial', 'unpaid'];
        backendPaymentStatus = validStatuses.includes(newPaymentStatus) ? newPaymentStatus : 'unpaid';
      }

      // Prepare booking details to save
      let bookingDetailsToSave = booking.booking_details;
      
      // If booking_details doesn't exist, try to parse from notes
      if (!bookingDetailsToSave && booking.notes) {
        try {
          bookingDetailsToSave = JSON.parse(booking.notes);
        } catch (e) {
          console.log('Notes is not JSON, creating new booking_details');
        }
      }
      
      // Update payment info in booking_details
      if (bookingDetailsToSave) {
        bookingDetailsToSave.payment_status = newPaymentStatus;
        bookingDetailsToSave.amount_paid = Math.round(newAmountPaid);
        // Save invoice number and type to booking details
        bookingDetailsToSave.invoice_number = invoiceNumber;
        bookingDetailsToSave.invoice_type = invoiceType;
        
        // Save DP settings if invoice type is DP
        if (invoiceType === 'dp') {
          bookingDetailsToSave.dp_percentage = dpPercentage;
          bookingDetailsToSave.dp_amount = parseFloat(dpInputValue.replace(/[^\d]/g, '')) || 0;
        }
      }

      // Extract date and time from booking_date if it's in ISO format
      let bookingDate = booking.booking_date;
      let bookingTime = booking.booking_time;
      
      if (booking.booking_date && booking.booking_date.includes('T')) {
        const dateObj = new Date(booking.booking_date);
        bookingDate = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD
        bookingTime = dateObj.toTimeString().split(' ')[0].substring(0, 5); // HH:MM
      }

      // Convert status to English for backend (database constraint)
      let backendStatus = 'confirmed'; // default
      if (booking.status === 'completed' || booking.status === 'Selesai') {
        backendStatus = 'completed';
      } else if (booking.status === 'cancelled' || booking.status === 'Dibatalkan') {
        backendStatus = 'cancelled';
      } else if (booking.status === 'confirmed' || booking.status === 'Dijadwalkan') {
        backendStatus = 'confirmed';
      } else {
        // If status is already in English format, use it
        const validStatuses = ['confirmed', 'completed', 'cancelled'];
        backendStatus = validStatuses.includes(booking.status) ? booking.status : 'confirmed';
      }

      console.log('=== SAVE INVOICE DEBUG ===');
      console.log('Booking ID:', booking.id);
      console.log('Service ID:', booking.service_id, 'Type:', typeof booking.service_id);
      console.log('Original booking_date:', booking.booking_date);
      console.log('Formatted booking_date:', bookingDate);
      console.log('Original booking_time:', booking.booking_time);
      console.log('Formatted booking_time:', bookingTime);
      console.log('Original Status:', booking.status);
      console.log('Converted Status:', backendStatus);
      console.log('Original Payment Status:', booking.payment_status);
      console.log('New Payment Status:', newPaymentStatus);
      console.log('Converted Payment Status:', backendPaymentStatus);
      console.log('Amount Paid:', Math.round(newAmountPaid));
      console.log('Total Amount:', amounts.total);
      console.log('Invoice Number:', invoiceNumber);
      console.log('========================');

      const requestBody = {
        service_id: parseInt(booking.service_id),
        booking_date: bookingDate,
        booking_time: bookingTime,
        location_name: booking.location_name || '',
        location_map_url: booking.location_map_url || '',
        status: backendStatus,
        total_amount: amounts.total,
        notes: bookingDetailsToSave ? JSON.stringify(bookingDetailsToSave) : booking.notes || '',
        payment_status: backendPaymentStatus,
        amount_paid: Math.round(newAmountPaid),
      };

      console.log('Request body:', requestBody);

      const response = await api.put(`/user/bookings/${booking.id}`, requestBody);

      // Persist invoice counter locally so the invoice number is reserved
      try {
        if (invoiceNumber && invoiceNumber.startsWith('INV-')) {
          persistInvoiceCounterForNumber(invoiceNumber);
        }
      } catch (err) {
        console.warn('Failed to persist invoice counter locally:', err);
      }

      alert('Invoice berhasil disimpan! Status pembayaran telah diupdate.');
      
      if (onSave) {
        onSave();
      }
      
      onClose();
    } catch (error) {
      console.error('Error saving invoice:', error);
      alert(`Gagal menyimpan invoice: ${error.response?.data?.message || error.message}`);
    } finally {
      setIsSaving(false);
    }
  };

  const handleSaveInvoiceDisplayOnly = async () => {
    try {
      setIsSaving(true);

      // For display only, keep the exact same payment status as original
      let backendPaymentStatus = 'unpaid'; // default
      if (booking.payment_status === 'Lunas') {
        backendPaymentStatus = 'paid';
      } else if (booking.payment_status === 'paid') {
        backendPaymentStatus = 'paid';
      } else if (booking.payment_status === 'DP') {
        backendPaymentStatus = 'partial';
      } else if (booking.payment_status === 'partial') {
        backendPaymentStatus = 'partial';
      } else if (booking.payment_status === 'Belum Bayar') {
        backendPaymentStatus = 'unpaid';
      } else if (booking.payment_status === 'unpaid') {
        backendPaymentStatus = 'unpaid';
      } else {
        // If status is already in English format, use it
        const validStatuses = ['paid', 'partial', 'unpaid'];
        backendPaymentStatus = validStatuses.includes(booking.payment_status) ? booking.payment_status : 'unpaid';
      }

      // Prepare booking details to save
      let bookingDetailsToSave = booking.booking_details;
      
      // If booking_details doesn't exist, try to parse from notes
      if (!bookingDetailsToSave && booking.notes) {
        try {
          bookingDetailsToSave = JSON.parse(booking.notes);
        } catch (e) {
          console.log('Notes is not JSON, creating new booking_details');
        }
      }
      
      // Update invoice number and type in booking_details (but keep payment status and amount paid COMPLETELY unchanged)
      if (bookingDetailsToSave) {
        bookingDetailsToSave.invoice_number = invoiceNumber;
        bookingDetailsToSave.invoice_type = invoiceType;
        
        // Save DP settings if invoice type is DP
        if (invoiceType === 'dp') {
          bookingDetailsToSave.dp_percentage = dpPercentage;
          bookingDetailsToSave.dp_amount = parseFloat(dpInputValue.replace(/[^\d]/g, '')) || 0;
        }
        
        // DO NOT change payment_status or amount_paid for display only
        // bookingDetailsToSave.payment_status = ... (removed)
        // bookingDetailsToSave.amount_paid = ... (removed)
      }

      // Extract date and time from booking_date if it's in ISO format
      let bookingDate = booking.booking_date;
      let bookingTime = booking.booking_time;
      
      if (booking.booking_date && booking.booking_date.includes('T')) {
        const dateObj = new Date(booking.booking_date);
        bookingDate = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD
        bookingTime = dateObj.toTimeString().split(' ')[0].substring(0, 5); // HH:MM
      }

      // Convert status to English for backend (database constraint)
      let backendStatus = 'confirmed'; // default
      if (booking.status === 'completed' || booking.status === 'Selesai') {
        backendStatus = 'completed';
      } else if (booking.status === 'cancelled' || booking.status === 'Dibatalkan') {
        backendStatus = 'cancelled';
      } else if (booking.status === 'confirmed' || booking.status === 'Dijadwalkan') {
        backendStatus = 'confirmed';
      } else {
        // If status is already in English format, use it
        const validStatuses = ['confirmed', 'completed', 'cancelled'];
        backendStatus = validStatuses.includes(booking.status) ? booking.status : 'confirmed';
      }

      console.log('=== SAVE INVOICE DISPLAY ONLY DEBUG ===');
      console.log('Booking ID:', booking.id);
      console.log('Invoice Number:', invoiceNumber);
      console.log('Payment Status (UNCHANGED):', booking.payment_status);
      console.log('Amount Paid (UNCHANGED):', Math.round(booking.amount_paid || 0));
      console.log('========================');

      const requestBody = {
        service_id: parseInt(booking.service_id),
        booking_date: bookingDate,
        booking_time: bookingTime,
        location_name: booking.location_name || '',
        location_map_url: booking.location_map_url || '',
        status: backendStatus,
        total_amount: amounts.total,
        notes: bookingDetailsToSave ? JSON.stringify(bookingDetailsToSave) : booking.notes || '',
        payment_status: backendPaymentStatus, // Keep EXACTLY the same payment status
        amount_paid: Math.round(booking.amount_paid || 0), // Keep EXACTLY the same amount paid
      };

      console.log('Request body:', requestBody);

      const response = await api.put(`/user/bookings/${booking.id}`, requestBody);

      // Persist invoice counter locally so the invoice number is reserved
      try {
        if (invoiceNumber && invoiceNumber.startsWith('INV-')) {
          persistInvoiceCounterForNumber(invoiceNumber);
        }
      } catch (err) {
        console.warn('Failed to persist invoice counter locally:', err);
      }

      alert('Invoice berhasil disimpan! (hanya untuk tampilan, status pembayaran tidak berubah)');
      
      if (onSave) {
        onSave();
      }
      
      onClose();
    } catch (error) {
      console.error('Error saving invoice display only:', error);
      alert(`Gagal menyimpan invoice: ${error.response?.data?.message || error.message}`);
    } finally {
      setIsSaving(false);
    }
  };

  const handleDownloadPDF = () => {
    if (!invoiceType) {
      alert('Pilih jenis invoice terlebih dahulu');
      return;
    }
    // Set default filename
    const defaultName = `Invoice-${invoiceNumber || 'DRAFT'}-${booking?.client_name || 'Client'}`;
    setFileName(defaultName);
    setDownloadFormat('pdf');
    setShowDownloadModal(true);
  };

  const handleDownloadJPEG = () => {
    if (!invoiceType) {
      alert('Pilih jenis invoice terlebih dahulu');
      return;
    }
    // Set default filename
    const defaultName = `Invoice-${invoiceNumber || 'DRAFT'}-${booking?.client_name || 'Client'}`;
    setFileName(defaultName);
    setDownloadFormat('jpeg');
    setShowDownloadModal(true);
  };

  const executeDownload = async () => {
    if (!fileName.trim()) {
      alert('Nama file tidak boleh kosong');
      return;
    }

    try {
      const invoiceElement = invoiceRef.current;
      if (!invoiceElement) {
        alert('Invoice tidak ditemukan');
        return;
      }

      // Capture invoice as canvas with higher quality
      const canvas = await html2canvas(invoiceElement, {
        scale: 2.5, // Balanced quality
        useCORS: true,
        logging: false,
        backgroundColor: '#ffffff',
        windowWidth: invoiceElement.scrollWidth,
        windowHeight: invoiceElement.scrollHeight,
        imageTimeout: 0,
        removeContainer: true
      });

      if (downloadFormat === 'pdf') {
        // Generate PDF - fit to one page, start from top
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 297; // A4 height in mm
        let imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        // If content is taller than A4, scale it down to fit
        if (imgHeight > pageHeight) {
          imgHeight = pageHeight;
        }
        
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgData = canvas.toDataURL('image/jpeg', 0.95);
        
        // Always start from top (yPosition = 0) to ensure logo is at the very top
        pdf.addImage(imgData, 'JPEG', 0, 0, imgWidth, imgHeight);
        pdf.save(`${fileName}.pdf`);
      } else {
        // Generate JPEG with high quality
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `${fileName}.jpg`;
          link.click();
          URL.revokeObjectURL(url);
        }, 'image/jpeg', 0.95);
      }

      setShowDownloadModal(false);
      alert(`Invoice berhasil didownload sebagai ${downloadFormat.toUpperCase()}`);
    } catch (error) {
      console.error('Error downloading invoice:', error);
      alert('Gagal download invoice. Silakan coba lagi.');
    }
  };

  // Update dpInputValue when invoice type changes
  useEffect(() => {
    if (invoiceType === 'dp') {
      // Set initial value saat pertama kali buka
      const initialDp = Math.round((amounts.total * dpPercentage) / 100);
      setDpInputValue(initialDp.toLocaleString('id-ID'));
    }
  }, [invoiceType]);

  if (!isOpen || !booking) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-2 sm:p-4">
      <div className="bg-white rounded-lg sm:rounded-xl shadow-xl w-full max-w-4xl max-h-[95vh] sm:max-h-[90vh] overflow-hidden flex flex-col">
        {/* Header */}
        <div className="bg-white border-b border-gray-200 px-3 sm:px-4 md:px-6 py-3 sm:py-4 flex items-center justify-between flex-shrink-0">
          <h2 className="text-base sm:text-lg md:text-xl font-bold text-gray-900">Generate Invoice</h2>
          <div className="flex items-center gap-1 sm:gap-2">
            <Button variant="secondary" size="sm" icon={<FiDownload />} onClick={handleDownloadPDF} className="flex px-1 sm:px-1.5 md:px-2 lg:px-3 py-0.5 sm:py-1 md:py-1.5 lg:py-2 text-xs sm:text-xs md:text-sm">
              PDF
            </Button>
            <Button variant="secondary" size="sm" icon={<FiDownload />} onClick={handleDownloadJPEG} className="flex px-1 sm:px-1.5 md:px-2 lg:px-3 py-0.5 sm:py-1 md:py-1.5 lg:py-2 text-xs sm:text-xs md:text-sm">
              JPEG
            </Button>
            <button onClick={onClose} className="text-gray-400 hover:text-gray-600 transition-colors p-0.5 sm:p-1">
              <FiX className="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 lg:w-6 lg:h-6" />
            </button>
          </div>
        </div>

        {/* Scrollable Content */}
        <div className="flex-1 overflow-y-auto">
          <div className="p-3 sm:p-4 md:p-6 space-y-4 sm:space-y-6 bg-gradient-to-br from-blue-50 to-indigo-50 border-b">
            {/* Info Banner */}
            <div className="bg-blue-100 border-l-4 border-blue-500 rounded-r-lg p-3 sm:p-4">
              <div className="flex items-start gap-2 sm:gap-3">
                <FiInfo className="w-4 h-4 sm:w-5 sm:h-5 text-blue-600 mt-0.5 flex-shrink-0" />
                <div className="text-xs sm:text-sm text-blue-800">
                  <p className="font-semibold mb-1">Pilih jenis invoice di sini:</p>
                  <ul className="space-y-1 ml-4 list-disc">
                    <li><span className="font-semibold">Invoice DP</span> untuk pembayaran awal, atau <span className="font-semibold">Invoice Pelunasan</span> untuk sisa pembayaran, atau <span className="font-semibold">Invoice Penuh</span> untuk pembayaran langsung</li>
                    <li>Diskon dan PPN dihitung dari halaman edit booking</li>
                  </ul>
                </div>
              </div>
            </div>

            <div>
              <h3 className="text-sm sm:text-base md:text-lg font-semibold text-gray-900 mb-3 sm:mb-4">Pilih Jenis Invoice</h3>
              
              {/* Status Info untuk DP */}
              {(booking.payment_status === 'DP' || booking.payment_status === 'partial') && (
                <div className="mb-3 sm:mb-4 p-3 sm:p-4 bg-orange-50 border-l-4 border-orange-500 rounded-r-lg">
                  <div className="flex items-start gap-2 sm:gap-3">
                    <svg className="w-4 h-4 sm:w-5 sm:h-5 text-orange-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <div>
                      <p className="text-xs sm:text-sm font-semibold text-orange-800 mb-1">⚠️ Status: Down Payment (DP) - Invoice Pelunasan Saja</p>
                      <p className="text-xs sm:text-sm text-orange-700">
                        Sudah dibayar: <span className="font-bold">Rp {Math.round(booking.amount_paid || 0).toLocaleString('id-ID')}</span>
                      </p>
                      <p className="text-xs sm:text-sm text-orange-700">
                        Sisa pembayaran: <span className="font-bold">Rp {Math.round(amounts.total - (booking.amount_paid || 0)).toLocaleString('id-ID')}</span>
                      </p>
                      <p className="text-xs text-orange-600 mt-1 italic">
                        ℹ️ Invoice DP sudah dibuat. Anda hanya dapat membuat Invoice Pelunasan untuk menyelesaikan pembayaran.
                      </p>
                    </div>
                  </div>
                </div>
              )}

              <p className="text-xs sm:text-sm text-gray-600 mb-3 sm:mb-4">
                {booking.payment_status === 'Lunas' || booking.payment_status === 'paid' 
                  ? '✓ Pembayaran sudah lunas - Invoice Penuh' 
                  : booking.payment_status === 'DP' || booking.payment_status === 'partial'
                  ? '⚠️ Hanya Invoice Pelunasan yang tersedia (DP sudah dibuat sebelumnya)'
                  : 'Pilih Invoice DP atau Invoice Penuh'}
              </p>
              
              {/* Invoice Type Buttons */}
              <div className="space-y-2 sm:space-y-3">
                <div className="grid grid-cols-3 gap-1.5 sm:gap-2 md:gap-4">
                  {/* Invoice DP */}
                  <button
                    type="button"
                    onClick={() => setInvoiceType('dp')}
                    disabled={
                      booking.payment_status === 'Lunas' || 
                      booking.payment_status === 'paid' || 
                      booking.payment_status === 'DP' || 
                      booking.payment_status === 'partial'
                    }
                    className={`relative flex flex-col items-center p-1.5 sm:p-2 md:p-3 lg:p-5 border-2 rounded-md sm:rounded-lg md:rounded-xl transition-all duration-200 ${
                      invoiceType === 'dp' 
                        ? 'border-blue-500 bg-blue-50 shadow-lg scale-105' 
                        : (booking.payment_status === 'Lunas' || booking.payment_status === 'paid' || booking.payment_status === 'DP' || booking.payment_status === 'partial')
                        ? 'border-gray-200 bg-gray-100 cursor-not-allowed opacity-50'
                        : 'border-gray-300 bg-white hover:border-blue-400 hover:shadow-md'
                    }`}
                  >
                    {invoiceType === 'dp' && (
                      <div className="absolute -top-0.5 -right-0.5 sm:-top-1 sm:-right-1 md:-top-2 md:-right-2 w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 lg:w-6 lg:h-6 bg-blue-500 rounded-full flex items-center justify-center">
                        <svg className="w-1.5 h-1.5 sm:w-2 sm:h-2 md:w-3 md:h-3 lg:w-4 lg:h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                          <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                        </svg>
                      </div>
                    )}
                    <div className="w-6 h-6 sm:w-8 sm:h-8 md:w-10 md:h-10 lg:w-12 lg:h-12 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-full flex items-center justify-center mb-0.5 sm:mb-1 md:mb-2 lg:mb-3">
                      <span className="text-white font-bold text-xs sm:text-xs md:text-sm lg:text-lg">DP</span>
                    </div>
                    <div className="text-center">
                      <div className="font-semibold text-gray-900 text-xs sm:text-xs md:text-sm lg:text-base mb-0 sm:mb-0.5 md:mb-1">Invoice DP</div>
                      <div className="text-xs text-gray-500 hidden sm:block">
                        {(booking.payment_status === 'DP' || booking.payment_status === 'partial')
                          ? 'DP sudah dibuat'
                          : 'Pembayaran DP'}
                      </div>
                      <div className="text-xs text-gray-500 sm:hidden">
                        DP
                      </div>
                    </div>
                  </button>

                  {/* Invoice Pelunasan */}
                  <button
                    type="button"
                    onClick={() => setInvoiceType('pelunasan')}
                    disabled={
                      booking.payment_status !== 'DP' && 
                      booking.payment_status !== 'partial'
                    }
                    className={`relative flex flex-col items-center p-1.5 sm:p-2 md:p-3 lg:p-5 border-2 rounded-md sm:rounded-lg md:rounded-xl transition-all duration-200 ${
                      invoiceType === 'pelunasan' 
                        ? 'border-orange-500 bg-orange-50 shadow-lg scale-105' 
                        : (booking.payment_status !== 'DP' && booking.payment_status !== 'partial')
                        ? 'border-gray-200 bg-gray-100 cursor-not-allowed opacity-50'
                        : 'border-gray-300 bg-white hover:border-orange-400 hover:shadow-md'
                    }`}
                  >
                    {invoiceType === 'pelunasan' && (
                      <div className="absolute -top-0.5 -right-0.5 sm:-top-1 sm:-right-1 md:-top-2 md:-right-2 w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 lg:w-6 lg:h-6 bg-orange-500 rounded-full flex items-center justify-center">
                        <svg className="w-1.5 h-1.5 sm:w-2 sm:h-2 md:w-3 md:h-3 lg:w-4 lg:h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                          <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                        </svg>
                      </div>
                    )}
                    <div className="w-6 h-6 sm:w-8 sm:h-8 md:w-10 md:h-10 lg:w-12 lg:h-12 bg-gradient-to-br from-orange-400 to-red-500 rounded-full flex items-center justify-center mb-0.5 sm:mb-1 md:mb-2 lg:mb-3">
                      <svg className="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 lg:w-6 lg:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </div>
                    <div className="text-center">
                      <div className="font-semibold text-gray-900 text-xs sm:text-xs md:text-sm lg:text-base mb-0 sm:mb-0.5 md:mb-1">Invoice Pelunasan</div>
                      <div className="text-xs text-gray-500 hidden sm:block">Sisa pembayaran</div>
                      <div className="text-xs text-gray-500 sm:hidden">
                        Pelunasan
                      </div>
                    </div>
                  </button>

                  {/* Invoice Penuh */}
                  <button
                    type="button"
                    onClick={() => setInvoiceType('penuh')}
                    disabled={
                      booking.payment_status === 'Lunas' || 
                      booking.payment_status === 'paid' || 
                      booking.payment_status === 'DP' || 
                      booking.payment_status === 'partial'
                    }
                    className={`relative flex flex-col items-center p-1.5 sm:p-2 md:p-3 lg:p-5 border-2 rounded-md sm:rounded-lg md:rounded-xl transition-all duration-200 ${
                      invoiceType === 'penuh' 
                        ? 'border-green-500 bg-green-50 shadow-lg scale-105' 
                        : (booking.payment_status === 'Lunas' || booking.payment_status === 'paid')
                        ? 'border-green-400 bg-green-50 cursor-default'
                        : (booking.payment_status === 'DP' || booking.payment_status === 'partial')
                        ? 'border-gray-200 bg-gray-100 cursor-not-allowed opacity-50'
                        : 'border-gray-300 bg-white hover:border-green-400 hover:shadow-md'
                    }`}
                  >
                    {invoiceType === 'penuh' && (
                      <div className="absolute -top-0.5 -right-0.5 sm:-top-1 sm:-right-1 md:-top-2 md:-right-2 w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 lg:w-6 lg:h-6 bg-green-500 rounded-full flex items-center justify-center">
                        <svg className="w-1.5 h-1.5 sm:w-2 sm:h-2 md:w-3 md:h-3 lg:w-4 lg:h-4 text-white" fill="currentColor" viewBox="0 0 20 20">
                          <path fillRule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clipRule="evenodd" />
                        </svg>
                      </div>
                    )}
                    <div className="w-6 h-6 sm:w-8 sm:h-8 md:w-10 md:h-10 lg:w-12 lg:h-12 bg-gradient-to-br from-green-400 to-emerald-500 rounded-full flex items-center justify-center mb-0.5 sm:mb-1 md:mb-2 lg:mb-3">
                      <svg className="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 lg:w-6 lg:h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </div>
                    <div className="text-center">
                      <div className="font-semibold text-gray-900 text-xs sm:text-xs md:text-sm lg:text-base mb-0 sm:mb-0.5 md:mb-1">Invoice Penuh</div>
                      <div className="text-xs text-gray-500 hidden sm:block">
                        {(booking.payment_status === 'DP' || booking.payment_status === 'partial')
                          ? 'Tidak tersedia untuk DP'
                          : 'Pembayaran langsung'}
                      </div>
                      <div className="text-xs text-gray-500 sm:hidden">
                        {(booking.payment_status === 'DP' || booking.payment_status === 'partial')
                          ? 'Tidak tersedia'
                          : 'Penuh'}
                      </div>
                    </div>
                  </button>
                </div>
                
                {/* DP Input Section */}
                {invoiceType === 'dp' && (
                  <div className="mt-3 sm:mt-4 p-3 sm:p-5 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg sm:rounded-xl border-2 border-yellow-200 shadow-sm">
                    <label className="flex text-xs sm:text-sm font-semibold text-gray-800 mb-2 sm:mb-3 items-center gap-2">
                      <div className="w-5 h-5 sm:w-6 sm:h-6 bg-yellow-500 rounded-full flex items-center justify-center">
                        <span className="text-white text-xs font-bold">%</span>
                      </div>
                      Persentase Down Payment (DP)
                    </label>
                    
                    {/* Slider dan Input Persentase */}
                    <div className="flex items-center gap-3 sm:gap-4 mb-2 sm:mb-3">
                      <input
                        type="range"
                        min="1"
                        max="90"
                        step="1"
                        value={dpPercentage}
                        onChange={(e) => {
                          const newPercentage = parseInt(e.target.value);
                          setDpPercentage(newPercentage);
                          // Update nominal input value
                          const newDpAmount = Math.round((amounts.total * newPercentage) / 100);
                          setDpInputValue(newDpAmount.toLocaleString('id-ID'));
                        }}
                        className="flex-1 h-2 bg-yellow-200 rounded-lg appearance-none cursor-pointer slider"
                        style={{
                          background: `linear-gradient(to right, #f59e0b 0%, #f59e0b ${(dpPercentage/90)*100}%, #fef3c7 ${(dpPercentage/90)*100}%, #fef3c7 100%)`
                        }}
                      />
                      <div className="relative">
                        <div className="w-20 sm:w-24 px-3 sm:px-4 py-1 sm:py-2 text-base sm:text-lg md:text-2xl font-bold text-yellow-600 text-center bg-white rounded-lg border-2 border-yellow-300">
                          {Math.round(dpPercentage)}%
                        </div>
                      </div>
                    </div>
                    
                    {/* Input Nominal DP Manual */}
                    <div className="mt-3 sm:mt-4 p-2 sm:p-3 bg-white rounded-lg border-2 border-yellow-300">
                      <label className="block text-xs font-semibold text-gray-700 mb-1 sm:mb-2">
                        Atau masukkan nominal DP langsung:
                      </label>
                      <div className="relative">
                        <span className="absolute left-2 sm:left-3 top-1/2 -translate-y-1/2 text-gray-500 font-medium text-sm sm:text-base">Rp</span>
                        <input
                          type="text"
                          value={dpInputValue}
                          onChange={(e) => {
                            const value = e.target.value.replace(/\./g, '');
                            const numValue = parseInt(value) || 0;
                            const maxDp = Math.round((amounts.total * 90) / 100);
                            
                            // Batasi maksimal 90% dari total
                            const clampedValue = Math.min(numValue, maxDp);
                            
                            setDpInputValue(clampedValue > 0 ? clampedValue.toLocaleString('id-ID') : '');
                            
                            // Update persentase berdasarkan nominal
                            const percentage = clampedValue > 0 ? (clampedValue / amounts.total) * 100 : 0;
                            setDpPercentage(parseFloat(percentage.toFixed(2)));
                          }}
                          placeholder="0"
                          className="w-full pl-8 sm:pl-10 pr-3 py-2 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 font-semibold text-gray-700 text-sm sm:text-base"
                        />
                      </div>
                      <p className="text-xs text-gray-500 mt-1 italic">
                        Total: Rp {Math.round(amounts.total).toLocaleString('id-ID')} | Maksimal DP (90%): Rp {Math.round((amounts.total * 90) / 100).toLocaleString('id-ID')}
                      </p>
                    </div>
                    
                    <div className="mt-3 text-sm text-gray-700 bg-white/60 p-3 rounded-lg">
                      <div className="flex justify-between items-center">
                        <span>Jumlah DP ({dpPercentage.toFixed(2)}%):</span>
                        <span className="font-bold text-yellow-700 text-sm sm:text-base md:text-lg">
                          Rp {Math.round(amounts.dp).toLocaleString('id-ID')}
                        </span>
                      </div>
                    </div>
                    
                    {/* Warning jika mendekati atau mencapai 90% */}
                    {dpPercentage >= 85 && (
                      <div className="mt-3 p-3 bg-orange-50 border-l-4 border-orange-500 rounded-r-lg">
                        <div className="flex items-start gap-2">
                          <svg className="w-5 h-5 text-orange-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                          </svg>
                          <div className="text-xs text-orange-800">
                            <p className="font-semibold">
                              {dpPercentage >= 90 ? '⚠️ DP maksimal 90% tercapai!' : '⚠️ DP mendekati batas maksimal'}
                            </p>
                            <p className="mt-1">Maksimal DP adalah 90% dari total pembayaran (Rp {Math.round((amounts.total * 90) / 100).toLocaleString('id-ID')})</p>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* Summary Box */}
                {invoiceType && (
                  <div className="mt-2 sm:mt-3 md:mt-4 p-2 sm:p-3 md:p-5 bg-white rounded-lg sm:rounded-xl border-2 border-gray-200 shadow-lg">
                    <h4 className="flex font-bold text-gray-900 mb-2 sm:mb-3 md:mb-4 items-center gap-1.5 sm:gap-2 text-sm sm:text-base md:text-lg">
                      <div className="w-5 h-5 sm:w-6 sm:h-6 md:w-8 md:h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center">
                        <svg className="w-3 h-3 sm:w-4 sm:h-4 md:w-5 md:h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                      </div>
                      Rincian Pembayaran
                    </h4>
                    
                    {invoiceType === 'dp' && (
                      <div className="space-y-2 sm:space-y-3">
                        {(booking.payment_status === 'DP' || booking.payment_status === 'partial') && booking.amount_paid > 0 && (
                          <div className="flex justify-between items-center p-2 sm:p-3 bg-green-50 rounded-lg border border-green-200">
                            <div>
                              <span className="text-xs sm:text-sm text-gray-700">Sudah Dibayar</span>
                              <span className="text-xs text-green-600 ml-1 sm:ml-2 font-semibold">
                                ({((booking.amount_paid / amounts.total) * 100).toFixed(2).replace('.', ',')}%)
                              </span>
                            </div>
                            <span className="text-sm sm:text-base md:text-lg font-bold text-green-700">Rp {(booking.amount_paid || 0).toLocaleString('id-ID')}</span>
                          </div>
                        )}
                        <div className="flex justify-between items-center p-2 sm:p-3 bg-yellow-50 rounded-lg border border-yellow-200">
                          <div>
                            <span className="text-xs sm:text-sm text-gray-700">Down Payment ({dpPercentage.toLocaleString('id-ID', { minimumFractionDigits: 0, maximumFractionDigits: 2 })}%)</span>
                            <p className="text-xs text-yellow-600 italic">
                              {(booking.payment_status === 'DP' || booking.payment_status === 'partial') 
                                ? 'Update nominal DP' 
                                : 'DP yang akan dibayar'}
                            </p>
                          </div>
                          <span className="text-sm sm:text-base md:text-lg font-bold text-yellow-700">Rp {Math.round(amounts.dp).toLocaleString('id-ID')}</span>
                        </div>
                        <div className="flex justify-between items-center p-2 sm:p-3 bg-gray-50 rounded-lg">
                          <span className="text-xs sm:text-sm text-gray-700">Sisa Setelah DP</span>
                          <span className="text-sm sm:text-base md:text-lg font-bold text-gray-700">Rp {Math.round(amounts.remaining).toLocaleString('id-ID')}</span>
                        </div>
                        <div className="pt-2 sm:pt-3 border-t-2 border-gray-200">
                          <div className="flex justify-between items-center">
                            <span className="text-xs sm:text-sm font-medium text-gray-600">Total Keseluruhan</span>
                            <span className="text-sm sm:text-base md:text-lg font-bold text-blue-600">Rp {Math.round(amounts.total).toLocaleString('id-ID')}</span>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    {invoiceType === 'pelunasan' && (
                      <div className="space-y-2 sm:space-y-3">
                        <div className="flex justify-between items-center p-2 sm:p-3 bg-green-50 rounded-lg border border-green-200">
                          <div>
                            <span className="text-xs sm:text-sm text-gray-700">Sudah Dibayar</span>
                            <span className="text-xs text-green-600 ml-1 sm:ml-2 font-semibold">
                              ({((booking.amount_paid / amounts.total) * 100).toFixed(2).replace('.', ',')}%)
                            </span>
                          </div>
                          <span className="text-sm sm:text-base md:text-lg font-bold text-green-700">Rp {Math.round(booking.amount_paid || 0).toLocaleString('id-ID')}</span>
                        </div>
                        <div className="flex justify-between items-center p-2 sm:p-3 bg-red-50 rounded-lg border border-red-200">
                          <div>
                            <span className="text-xs sm:text-sm text-gray-700">Sisa Pembayaran</span>
                            <span className="text-xs text-red-600 ml-1 sm:ml-2 font-semibold">
                              ({((amounts.remaining / amounts.total) * 100).toFixed(2).replace('.', ',')}%)
                            </span>
                          </div>
                          <span className="text-sm sm:text-base md:text-lg font-bold text-red-600">Rp {Math.round(amounts.remaining).toLocaleString('id-ID')}</span>
                        </div>
                        <div className="pt-2 sm:pt-3 border-t-2 border-gray-200">
                          <div className="flex justify-between items-center">
                            <span className="text-xs sm:text-sm font-medium text-gray-600">Total Keseluruhan</span>
                            <span className="text-sm sm:text-base md:text-lg font-bold text-blue-600">Rp {Math.round(amounts.total).toLocaleString('id-ID')}</span>
                          </div>
                        </div>
                      </div>
                    )}
                    
                    {invoiceType === 'penuh' && (
                      <div className="space-y-2 sm:space-y-3">
                        <div className="flex justify-between items-center p-2 sm:p-3 md:p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-200">
                          <span className="text-xs sm:text-sm font-medium text-gray-700">Total Pembayaran</span>
                          <span className="text-sm sm:text-base md:text-lg lg:text-xl font-bold text-green-600">Rp {Math.round(amounts.total).toLocaleString('id-ID')}</span>
                        </div>
                        <div className="text-xs text-gray-500 text-center">
                          {booking.payment_status === 'Lunas' || booking.payment_status === 'paid' 
                            ? '✓ Pembayaran telah lunas' 
                            : 'Pembayaran langsung tanpa DP'}
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </div>

              {/* Invoice Details */}
              <div className="grid grid-cols-3 gap-1.5 sm:gap-2 mt-3 sm:mt-4">
                <div>
                  <label className="flex text-xs font-semibold text-gray-700 mb-0.5 items-center gap-0.5">
                    <svg className="w-2.5 h-2.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14" />
                    </svg>
                    Nomor Invoice
                  </label>
                  <input
                    type="text"
                    value={invoiceNumber}
                    onChange={(e) => setInvoiceNumber(e.target.value)}
                    className="w-full px-1.5 py-1 border-2 border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white font-mono text-xs"
                    placeholder="INV-xxxxx"
                  />
                </div>

                <div>
                  <label className="flex text-xs font-semibold text-gray-700 mb-0.5 items-center gap-0.5">
                    <svg className="w-2.5 h-2.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    Tanggal Invoice
                  </label>
                  <input
                    type="date"
                    value={invoiceDate}
                    onChange={(e) => setInvoiceDate(e.target.value)}
                    className="w-full px-1.5 py-1 border-2 border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white text-xs"
                  />
                </div>

                <div>
                  <label className="flex text-xs font-semibold text-gray-700 mb-0.5 items-center gap-0.5">
                    <svg className="w-2.5 h-2.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    Jatuh Tempo
                  </label>
                  <input
                    type="date"
                    value={dueDate}
                    onChange={(e) => setDueDate(e.target.value)}
                    className="w-full px-1.5 py-1 border-2 border-gray-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 transition-all bg-white text-xs"
                  />
                </div>
              </div>
            </div>
          </div>

          {/* Invoice Preview - Visible in Modal */}
          {invoiceType ? (
            <div className="p-2 sm:p-3 md:p-6 bg-gray-50">
              <div className="border border-gray-300 rounded-lg p-2 sm:p-3 md:p-6 bg-white shadow-lg max-w-4xl mx-auto" style={{ fontFamily: "'Times New Roman', Times, serif" }}>
                {/* Company Info */}
                <div className="flex justify-between items-start mb-3 sm:mb-4 md:mb-6 pb-2 sm:pb-3 md:pb-4 border-b-2 border-gray-200">
                  <div>
                    {companySettings?.company_logo_url && (
                      <img src={companySettings.company_logo_url} alt="Company Logo" className="h-6 sm:h-8 md:h-12 mb-1 sm:mb-2 object-contain" />
                    )}
                    <h1 className="text-sm sm:text-lg md:text-xl lg:text-2xl font-bold text-gray-900">{companySettings?.company_name || 'Nama Perusahaan'}</h1>
                    {companySettings?.company_address && <p className="text-xs text-gray-600 mt-0.5">{companySettings.company_address}</p>}
                    {companySettings?.company_phone && <p className="text-xs text-gray-600">Kontak: {companySettings.company_phone}</p>}
                    {companySettings?.company_email && <p className="text-xs text-gray-600">Email: {companySettings.company_email}</p>}
                  </div>
                  <div className="text-right">
                    <h2 className="text-sm sm:text-lg md:text-xl lg:text-2xl font-bold text-gray-900">INVOICE</h2>
                    <p className="text-xs text-gray-600 mt-0.5 sm:mt-1">{invoiceNumber}</p>
                  </div>
                </div>

                {/* Bill To */}
                <div className="mb-2 sm:mb-3 md:mb-4">
                  <h3 className="text-xs font-semibold text-gray-700 mb-1">Bill To:</h3>
                  <p className="font-semibold text-gray-900 text-sm">{booking.client_name}</p>
                  <p className="text-xs text-gray-600">{formatPhoneNumber(booking.contact)}</p>
                  {(booking.address || booking.location) && (
                    <p className="text-xs text-gray-600 mt-0.5">{booking.address || booking.location}</p>
                  )}
                </div>

                {/* Invoice Dates */}
                <div className="mb-2 sm:mb-3 md:mb-4 grid grid-cols-1 sm:grid-cols-2 gap-1 sm:gap-2">
                  <div>
                    <p className="text-xs text-gray-600">Tanggal Invoice: {new Date(invoiceDate).toLocaleDateString('id-ID')}</p>
                  </div>
                  <div>
                    <p className="text-xs text-gray-600">Jatuh Tempo: {new Date(dueDate).toLocaleDateString('id-ID')}</p>
                  </div>
                  <div className="sm:col-span-2">
                    <p className="text-xs sm:text-sm text-gray-600">Tanggal Layanan: {new Date(booking.booking_date).toLocaleDateString('id-ID')}</p>
                  </div>
                </div>

                {/* Invoice Items Table */}
                <table className="w-full mb-2 sm:mb-3 md:mb-4" style={{ fontFamily: "'Times New Roman', Times, serif" }}>
                  <thead className="bg-gray-50 border-b">
                    <tr>
                      <th className="text-left py-1 px-1 sm:px-2 text-xs font-semibold text-gray-700">Deskripsi Layanan</th>
                      <th className="text-center py-1 px-1 sm:px-2 text-xs font-semibold text-gray-700">Tanggal & Waktu Mulai</th>
                      <th className="text-center py-1 px-1 sm:px-2 text-xs font-semibold text-gray-700">Tanggal & Waktu Selesai</th>
                      <th className="text-right py-1 px-1 sm:px-2 text-xs font-semibold text-gray-700">Harga Layanan</th>
                      <th className="text-right py-1 px-1 sm:px-2 text-xs font-semibold text-gray-700">Jumlah</th>
                    </tr>
                  </thead>
                  <tbody>
                    {amounts.services && amounts.services.length > 0 ? (
                      amounts.services.map((service, index) => {
                        const details = booking.booking_details;
                        const bookingDays = details?.booking_days || 1;
                        const hasEndDate = details?.booking_date_end;
                        
                        // Prioritas pengambilan waktu mulai: booking_details > booking table > fallback
                        let startTime = '09:00';
                        if (details?.booking_time) {
                          startTime = details.booking_time;
                        } else if (booking.booking_time) {
                          startTime = booking.booking_time;
                        }
                        
                        // Prioritas pengambilan waktu selesai
                        let endTime = '17:00';
                        if (details?.booking_time_end) {
                          endTime = details.booking_time_end;
                        } else if (booking.booking_time_end) {
                          endTime = booking.booking_time_end;
                        }
                        
                        return (
                          <tr key={index} className="border-b">
                            <td className="py-1 sm:py-2 px-1 sm:px-2 text-xs text-gray-900">
                              {service.service_name}
                              {service.quantity > 1 && <span className="ml-1 text-green-600 font-semibold text-xs">(x{service.quantity})</span>}
                              {bookingDays > 1 && <span className="ml-1 text-blue-600 font-semibold text-xs">x{bookingDays} hari</span>}
                            </td>
                            <td className="py-1 sm:py-2 px-1 sm:px-2 text-xs text-gray-600 text-center">
                              {new Date(booking.booking_date).toLocaleDateString('id-ID')}<br/>
                              <span className="font-semibold">{startTime}</span>
                            </td>
                            <td className="py-1 sm:py-2 px-1 sm:px-2 text-xs text-gray-600 text-center">
                              {hasEndDate ? (
                                <>
                                  {new Date(details.booking_date_end).toLocaleDateString('id-ID')}<br/>
                                  <span className="font-semibold">{endTime}</span>
                                </>
                              ) : (
                                <>
                                  {new Date(booking.booking_date).toLocaleDateString('id-ID')}<br/>
                                  <span className="font-semibold">{endTime}</span>
                                </>
                              )}
                            </td>
                            <td className="py-1 sm:py-2 px-1 sm:px-2 text-xs text-gray-900 text-right">
                              Rp {Math.round(service.custom_price || 0).toLocaleString('id-ID')}
                            </td>
                            <td className="py-1 sm:py-2 px-1 sm:px-2 text-xs text-gray-900 text-right">
                              Rp {Math.round((service.custom_price || 0) * (service.quantity || 1) * bookingDays).toLocaleString('id-ID')}
                              {(service.quantity > 1 || bookingDays > 1) && (
                                <div className="text-xs text-gray-500 mt-0.5">
                                  ({service.quantity || 1} x Rp {Math.round(service.custom_price || 0).toLocaleString('id-ID')} x {bookingDays} hari)
                                </div>
                              )}
                            </td>
                          </tr>
                        );
                      })
                    ) : (
                      booking.services?.map((service, index) => {
                        const details = booking.booking_details;
                        const bookingDays = details?.booking_days || 1;
                        const hasEndDate = details?.booking_date_end;
                        
                        // Prioritas pengambilan waktu mulai: booking_details > booking table > fallback
                        let startTime = '09:00';
                        if (details?.booking_time) {
                          startTime = details.booking_time;
                        } else if (booking.booking_time) {
                          startTime = booking.booking_time;
                        }
                        
                        // Prioritas pengambilan waktu selesai
                        let endTime = '17:00';
                        if (details?.booking_time_end) {
                          endTime = details.booking_time_end;
                        } else if (booking.booking_time_end) {
                          endTime = booking.booking_time_end;
                        }
                        return (
                          <tr key={index} className="border-b">
                            <td className="py-1 sm:py-2 px-1 sm:px-2 text-xs text-gray-900">
                              {service}
                              {bookingDays > 1 && <span className="ml-1 text-blue-600 font-semibold text-xs">x{bookingDays}</span>}
                            </td>
                            <td className="py-1 sm:py-2 px-1 sm:px-2 text-xs text-gray-600 text-center">
                              {new Date(booking.booking_date).toLocaleDateString('id-ID')}<br/>
                              <span className="font-semibold">{startTime}</span>
                            </td>
                            <td className="py-1 sm:py-2 px-1 sm:px-2 text-xs text-gray-600 text-center">
                              {hasEndDate ? (
                                <>
                                  {new Date(details.booking_date_end).toLocaleDateString('id-ID')}<br/>
                                  <span className="font-semibold">{endTime}</span>
                                </>
                              ) : (
                                <>
                                  {new Date(booking.booking_date).toLocaleDateString('id-ID')}<br/>
                                  <span className="font-semibold">{endTime}</span>
                                </>
                              )}
                            </td>
                            <td className="py-1 sm:py-2 px-1 sm:px-2 text-xs text-gray-900 text-right">
                              Rp {Math.round((booking.total_amount || 0) / bookingDays).toLocaleString('id-ID')}
                            </td>
                            <td className="py-1 sm:py-2 px-1 sm:px-2 text-xs text-gray-900 text-right">
                              Rp {Math.round(booking.total_amount || 0).toLocaleString('id-ID')}
                              {bookingDays > 1 && <div className="text-xs text-gray-500 mt-0.5">(Rp {Math.round((booking.total_amount || 0) / bookingDays).toLocaleString('id-ID')} x {bookingDays} hari)</div>}
                            </td>
                          </tr>
                        );
                      })
                    )}
                    
                    {/* Additional Fees */}
                    {amounts.additional_fees && amounts.additional_fees.length > 0 && amounts.additional_fees.map((fee, index) => (
                      <tr key={`fee-${index}`} className="border-b">
                        <td className="py-1 sm:py-2 px-1 sm:px-2 text-xs text-gray-900">{fee.description}</td>
                        <td className="py-1 sm:py-2 px-1 sm:px-2 text-xs text-gray-600 text-center">-</td>
                        <td className="py-1 sm:py-2 px-1 sm:px-2 text-xs text-gray-600 text-center">-</td>
                        <td className="py-1 sm:py-2 px-1 sm:px-2 text-xs text-gray-900 text-right">Rp {Math.round(fee.amount).toLocaleString('id-ID')}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>

                {/* Totals */}
                <div className="flex justify-end mb-2 sm:mb-3 md:mb-4">
                  <div className="w-40 sm:w-48 md:w-56 lg:w-64 space-y-0.5 sm:space-y-1">
                    {/* Services Subtotal */}
                    <div className="flex justify-between text-xs">
                      <span className="text-gray-600">Subtotal Layanan:</span>
                      <span className="font-semibold">Rp {Math.round(amounts.servicesSubtotal).toLocaleString('id-ID')}</span>
                    </div>
                    
                    {/* Discount */}
                    {amounts.discountAmount > 0 && (
                      <div className="flex justify-between text-xs">
                        <span className="text-gray-600">Diskon ({amounts.discountType === 'persen' ? `${amounts.discount}%` : 'Rp'}):</span>
                        <span className="font-semibold text-green-600">-Rp {Math.round(amounts.discountAmount).toLocaleString('id-ID')}</span>
                      </div>
                    )}
                    
                    {/* Tax */}
                    {amounts.tax_percentage > 0 && (
                      <div className="flex justify-between text-xs">
                        <span className="text-gray-600">PPN ({amounts.tax_percentage}%):</span>
                        <span className="font-semibold">Rp {Math.round(amounts.tax).toLocaleString('id-ID')}</span>
                      </div>
                    )}
                    
                    {/* Additional Fees Total */}
                    {amounts.additional_fees && amounts.additional_fees.length > 0 && (
                      <div className="flex justify-between text-xs">
                        <span className="text-gray-600">Biaya Tambahan:</span>
                        <span className="font-semibold">Rp {Math.round(amounts.additional_fees.reduce((sum, fee) => sum + parseFloat(fee.amount || 0), 0)).toLocaleString('id-ID')}</span>
                      </div>
                    )}
                    
                    {/* Grand Total */}
                    <div className="flex justify-between text-xs font-bold border-t-2 pt-1 mt-1">
                      <span className="text-gray-900">TOTAL KESELURUHAN:</span>
                      <span className="text-blue-600">Rp {Math.round(amounts.total).toLocaleString('id-ID')}</span>
                    </div>
                    
                    {/* Payment Information */}
                    {invoiceType === 'dp' && (
                      <>
                        <div className="border-t pt-1 mt-1"></div>
                        <div className="flex justify-between text-xs p-1 rounded">
                          <span className="text-gray-700 font-medium">DP yang harus dibayar:</span>
                          <span className="font-bold text-orange-600">Rp {Math.round(amounts.dp).toLocaleString('id-ID')}</span>
                        </div>
                        <div className="flex justify-between text-xs">
                          <span className="text-gray-600">Sisa Pembayaran:</span>
                          <span className="font-semibold text-red-600">Rp {Math.round(amounts.remaining).toLocaleString('id-ID')}</span>
                        </div>
                      </>
                    )}
                    {invoiceType === 'pelunasan' && (
                      <>
                        <div className="border-t pt-1 mt-1"></div>
                        <div className="flex justify-between text-xs text-gray-500 italic">
                          <span>Sudah Dibayar (DP):</span>
                          <span>-Rp {Math.round(booking.amount_paid || 0).toLocaleString('id-ID')}</span>
                        </div>
                        <div className="flex justify-between p-1 rounded">
                          <span className="font-bold text-gray-900 text-xs">Sisa yang Harus Dibayar:</span>
                          <span className="font-bold text-xs text-red-600">Rp {Math.round(amounts.remaining).toLocaleString('id-ID')}</span>
                        </div>
                      </>
                    )}
                    {invoiceType === 'penuh' && (
                      <>
                        <div className="border-t pt-1 mt-1"></div>
                        <div className="flex justify-between p-1 rounded">
                          <span className="font-bold text-gray-900 text-xs">Total Pembayaran Penuh:</span>
                          <span className="font-bold text-xs text-green-600">Rp {Math.round(amounts.total).toLocaleString('id-ID')}</span>
                        </div>
                      </>
                    )}
                  </div>
                </div>

                {/* Payment Info - Ultra Compact */}
                {companySettings?.bank_name && (
                  <div className="border-t pt-0.5 sm:pt-1">
                    <div className="border border-gray-300 rounded p-0.5 mb-0.5">
                      <h3 className="text-xs font-bold text-gray-900 mb-0.5">Informasi Pembayaran</h3>

                      <div className="space-y-0.5 text-xs mb-0.5">
                        <div>
                          <span className="text-gray-700">Status: </span>
                          <span className="font-bold text-gray-900">
                            {invoiceType === 'dp' ? 'Down Payment' : invoiceType === 'pelunasan' ? 'Pelunasan' : invoiceType === 'penuh' ? 'Lunas' : '-'}
                          </span>
                        </div>

                        <div>
                          <span className="text-gray-700">Sudah Dibayar: </span>
                          <span className="font-bold text-gray-900">
                            Rp {Math.round(booking.amount_paid || 0).toLocaleString('id-ID')}
                          </span>
                        </div>
                      </div>

                      {/* Sisa Pembayaran Box - Orange Highlight Compact */}
                      <div className="border border-orange-400 rounded p-0.5 text-center mb-0.5 w-3/5 mx-auto">
                        <p className="text-xs font-medium text-orange-900">
                          {invoiceType === 'dp' ? 'Pembayaran Awal' : invoiceType === 'pelunasan' ? 'Sisa Pembayaran' : invoiceType === 'penuh' ? 'Total Pembayaran' : 'Sisa pembayaran yang harus ditransfer'}
                        </p>
                        <p className="text-xs font-bold text-orange-600">
                          Rp {Math.round(getInvoiceAmount()).toLocaleString('id-ID')}
                        </p>
                      </div>

                      {/* Transfer Bank Section - Horizontal Grid Layout */}
                      <div>
                        <h4 className="text-xs font-bold text-gray-900 mb-0.5">Transfer Bank:</h4>
                        <div className="grid grid-cols-2 gap-0.5">
                          {companySettings.bank_name && (
                            <div className="bg-white border border-gray-300 rounded p-0.5">
                              <div className="text-xs">
                                <span className="text-gray-700">Bank: </span>
                                <span className="font-bold text-gray-900">{companySettings.bank_name}</span>
                              </div>
                              <div className="text-xs">
                                <span className="text-gray-700">No. Rekening: </span>
                                <span className="font-bold text-gray-900">{companySettings.account_number || '-'}</span>
                              </div>
                              <div className="text-xs">
                                <span className="text-gray-700">A.n: </span>
                                <span className="font-bold text-gray-900">{companySettings.account_holder_name || '-'}</span>
                              </div>
                            </div>
                          )}

                          {companySettings.bank_name_alt && (
                            <div className="bg-white border border-gray-300 rounded p-0.5">
                              <div className="text-xs">
                                <span className="text-gray-700">Bank: </span>
                                <span className="font-bold text-gray-900">{companySettings.bank_name_alt}</span>
                              </div>
                              <div className="text-xs">
                                <span className="text-gray-700">No. Rekening: </span>
                                <span className="font-bold text-gray-900">{companySettings.account_number_alt || '-'}</span>
                              </div>
                              <div className="text-xs">
                                <span className="text-gray-700">A.n: </span>
                                <span className="font-bold text-gray-900">{companySettings.account_holder_name_alt || '-'}</span>
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>

                    {/* Instructions - Ultra Compact */}
                    <div className="border border-orange-400 rounded p-0.5 mb-0.5">
                      <h4 className="text-xs font-bold text-gray-900">Instruksi Pembayaran:</h4>
                      <p className="text-xs text-gray-800">
                        {companySettings?.payment_instructions || 'Silakan transfer ke rekening di atas dan kirimkan bukti transfer untuk konfirmasi pembayaran.'}
                      </p>
                    </div>
                  </div>
                )}
              </div>
            </div>
          ) : (
            /* Instruction Section when no invoice type is selected */
            <div className="p-2 sm:p-3 md:p-6 bg-gray-50">
              <div className="max-w-4xl mx-auto text-center">
                <div className="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 sm:p-8 md:p-12">
                  <div className="w-16 h-16 sm:w-20 sm:h-20 md:w-24 md:h-24 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 sm:mb-6">
                    <svg className="w-8 h-8 sm:w-10 sm:h-10 md:w-12 md:h-12 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                  </div>
                  <h3 className="text-lg sm:text-xl md:text-2xl font-bold text-blue-900 mb-2 sm:mb-3 md:mb-4">
                    Pilih Jenis Invoice Terlebih Dahulu
                  </h3>
                  <p className="text-sm sm:text-base md:text-lg text-blue-800 mb-4 sm:mb-6 md:mb-8 max-w-2xl mx-auto">
                    Untuk melihat dan mengelola invoice, silakan pilih salah satu jenis invoice di atas terlebih dahulu.
                  </p>
                  <div className="flex flex-col sm:flex-row gap-3 sm:gap-4 justify-center items-center">
                    <div className="flex items-center gap-2 text-sm sm:text-base text-blue-700">
                      <div className="w-3 h-3 bg-yellow-500 rounded-full"></div>
                      <span><strong>Invoice DP</strong> - Untuk pembayaran awal</span>
                    </div>
                    <div className="flex items-center gap-2 text-sm sm:text-base text-blue-700">
                      <div className="w-3 h-3 bg-orange-500 rounded-full"></div>
                      <span><strong>Invoice Pelunasan</strong> - Untuk sisa pembayaran</span>
                    </div>
                    <div className="flex items-center gap-2 text-sm sm:text-base text-blue-700">
                      <div className="w-3 h-3 bg-green-500 rounded-full"></div>
                      <span><strong>Invoice Penuh</strong> - Untuk pembayaran langsung</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* Footer */}
        <div className="bg-white border-t border-gray-200 px-1.5 sm:px-2 md:px-3 lg:px-6 py-1.5 sm:py-2 md:py-3 flex justify-end gap-1 sm:gap-1.5 md:gap-2 flex-shrink-0">
          <Button 
            variant="secondary" 
            onClick={handleSaveInvoiceDisplayOnly}
            disabled={isSaving}
            className="px-1.5 py-1 text-xs sm:text-xs md:text-sm"
          >
            {isSaving ? 'Menyimpan...' : 'Belum Di Bayar'}
          </Button>
          {invoiceType && (
            <Button 
              variant="primary" 
              onClick={handleSaveInvoice}
              disabled={isSaving}
              className="px-1.5 py-1 text-xs sm:text-xs md:text-sm"
            >
              {isSaving ? 'Menyimpan...' : 'Invoice Dibayar'}
            </Button>
          )}
        </div>
      </div>

      {/* Hidden Invoice Template for Download - Compact Single Page */}
      {invoiceType && (
        <div className="absolute" style={{ left: '-9999px', top: 0, zIndex: -1 }}>
          <div ref={invoiceRef} className="bg-white pt-4 pb-4 px-4" style={{ width: '210mm', maxHeight: '297mm', fontFamily: "'Times New Roman', Times, serif" }}>
            {/* Header with Logo - Compact */}
            <div className="flex justify-between items-start mt-1 mb-1 pb-1 border-b-2 border-gray-300">
              <div>
                {companySettings?.company_logo_url && (
                  <img src={companySettings.company_logo_url} alt="Company Logo" className="h-8 object-contain" />
                )}
                <h1 className="text-lg font-bold text-gray-900">{companySettings?.company_name || 'Nama Perusahaan'}</h1>
                {companySettings?.company_address && <p className="text-xs text-gray-600">{companySettings.company_address}</p>}
                {companySettings?.company_phone && <p className="text-xs text-gray-600">Kontak: {companySettings.company_phone}</p>}
                {companySettings?.company_email && <p className="text-xs text-gray-600">Email: {companySettings.company_email}</p>}
              </div>
              <div className="text-right">
                <h2 className="text-xl font-bold text-gray-900">INVOICE</h2>
                <p className="text-sm text-gray-600 mt-1">{invoiceNumber}</p>
              </div>
            </div>

            {/* Bill To & Invoice Info - Compact & Clean */}
            <div className="grid grid-cols-2 gap-3 mb-1">
              <div>
                <h3 className="text-xs font-bold text-gray-700 mb-1">Bill To:</h3>
                <p className="text-sm font-bold text-gray-900">{booking.client_name}</p>
                <p className="text-xs text-gray-600">{formatPhoneNumber(booking.contact)}</p>
                {(booking.address || booking.location) && (
                  <p className="text-xs text-gray-600 mt-0.5">📍 {booking.address || booking.location}</p>
                )}
              </div>
              <div className="text-right">
                <table className="text-[10px] ml-auto">
                  <tbody>
                    <tr>
                      <td className="text-gray-600 pr-1 py-0">Tanggal Invoice:</td>
                      <td className="font-semibold text-gray-900">{new Date(invoiceDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' })}</td>
                    </tr>
                    <tr>
                      <td className="text-gray-600 pr-1 py-0">Jatuh Tempo:</td>
                      <td className="font-semibold text-gray-900">{new Date(dueDate).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' })}</td>
                    </tr>
                    <tr>
                      <td className="text-gray-600 pr-1 py-0">Tanggal Mulai:</td>
                      <td className="font-semibold text-gray-900">
                        {new Date(booking.booking_date).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' })}
                        {(bookingDetails?.booking_time || booking.booking_time) && ` - ${bookingDetails?.booking_time || booking.booking_time}`}
                      </td>
                    </tr>
                    {bookingDetails?.booking_date_end && (
                      <tr>
                        <td className="text-gray-600 pr-1 py-0">Tanggal Selesai:</td>
                        <td className="font-semibold text-gray-900">
                          {new Date(bookingDetails.booking_date_end).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' })}
                          {bookingDetails.booking_time_end && ` - ${bookingDetails.booking_time_end}`}
                        </td>
                      </tr>
                    )}
                    {bookingDetails?.booking_days && bookingDetails.booking_days > 1 && (
                      <tr>
                        <td className="text-gray-600 pr-1 py-0">Durasi:</td>
                        <td className="font-semibold text-gray-900">{bookingDetails.booking_days} Hari</td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </div>

            {/* Services Table - Compact */}
            <table className="w-full border-collapse" style={{ fontFamily: "'Times New Roman', Times, serif" }}>
              <thead>
                <tr className="bg-gray-100 border-b-2 border-gray-300">
                  <th className="text-left py-2 px-3 text-xs font-bold text-gray-700 border-r border-gray-300">Deskripsi Layanan</th>
                  <th className="text-center py-2 px-2 text-xs font-bold text-gray-700 border-r border-gray-300">Tanggal & Waktu Mulai</th>
                  <th className="text-center py-2 px-2 text-xs font-bold text-gray-700 border-r border-gray-300">Tanggal & Waktu Selesai</th>
                  <th className="text-right py-2 px-2 text-xs font-bold text-gray-700 border-r border-gray-300">Harga Layanan</th>
                  <th className="text-right py-2 px-3 text-xs font-bold text-gray-700">Jumlah</th>
                </tr>
              </thead>
              <tbody>
                {amounts.services && amounts.services.length > 0 ? (
                  amounts.services.map((service, index) => {
                    const details = booking.booking_details;
                    const bookingDays = details?.booking_days || 1;
                    const hasEndDate = details?.booking_date_end;
                    
                    // Debug log untuk melihat data yang tersedia
                    console.log('Service Index:', index);
                    console.log('details?.booking_time:', details?.booking_time);
                    console.log('booking.booking_time:', booking.booking_time);
                    
                    // Prioritas pengambilan waktu mulai: booking_details > booking table > fallback
                    let startTime = '09:00'; // default fallback
                    if (details?.booking_time) {
                      startTime = details.booking_time;
                    } else if (booking.booking_time) {
                      startTime = booking.booking_time;
                    }
                    
                    // Prioritas pengambilan waktu selesai
                    let endTime = '17:00'; // default fallback
                    if (details?.booking_time_end) {
                      endTime = details.booking_time_end;
                    } else if (booking.booking_time_end) {
                      endTime = booking.booking_time_end;
                    }
                    
                    console.log('Final startTime:', startTime);
                    console.log('Final endTime:', endTime);
                    
                    return (
                      <tr key={index} className="border-b border-gray-200">
                        <td className="py-2 px-3 text-xs align-top border-r border-gray-200">
                          <div className="font-semibold text-gray-900 break-words">
                            {service.service_name}
                            {service.quantity > 1 && <span className="ml-1 text-green-600 font-bold">(x{service.quantity})</span>}
                            {bookingDays > 1 && <span className="ml-1 text-blue-600 font-bold">x{bookingDays} hari</span>}
                          </div>
                          <div className="text-xs text-gray-500 mt-1 break-words">{service.description || ''}</div>
                        </td>
                        <td className="py-2 px-2 text-xs text-gray-600 text-center align-top border-r border-gray-200">
                          <div className="whitespace-nowrap">{new Date(booking.booking_date).toLocaleDateString('id-ID')}</div>
                          <div className="font-semibold whitespace-nowrap">{startTime}</div>
                        </td>
                        <td className="py-2 px-2 text-xs text-gray-600 text-center align-top border-r border-gray-200">
                          <div className="whitespace-nowrap">
                            {hasEndDate ? new Date(details.booking_date_end).toLocaleDateString('id-ID') : new Date(booking.booking_date).toLocaleDateString('id-ID')}
                          </div>
                          <div className="font-semibold whitespace-nowrap">{endTime}</div>
                        </td>
                        <td className="py-2 px-2 text-xs font-semibold text-gray-900 text-right align-top border-r border-gray-200 whitespace-nowrap">
                          Rp {Math.round(service.custom_price || 0).toLocaleString('id-ID')}
                        </td>
                        <td className="py-2 px-3 text-xs font-semibold text-gray-900 text-right align-top">
                          <div className="whitespace-nowrap">Rp {Math.round((service.custom_price || 0) * (service.quantity || 1) * bookingDays).toLocaleString('id-ID')}</div>
                          {(service.quantity > 1 || bookingDays > 1) && (
                            <div className="text-xs text-gray-500 mt-1 break-words">
                              ({service.quantity || 1} x Rp {Math.round(service.custom_price || 0).toLocaleString('id-ID')} x {bookingDays} hari)
                            </div>
                          )}
                        </td>
                      </tr>
                    );
                  })
                ) : (
                  <tr className="border-b border-gray-200">
                    <td className="py-2 px-3 text-xs align-top border-r border-gray-200">
                      <div className="font-semibold text-gray-900 break-words">
                        {booking.service_name}
                        {(booking.booking_details?.booking_days > 1) && (
                          <span className="ml-1 text-blue-600 font-bold">x{booking.booking_details.booking_days}</span>
                        )}
                      </div>
                    </td>
                    <td className="py-2 px-2 text-xs text-gray-600 text-center align-top border-r border-gray-200">
                      <div className="whitespace-nowrap">{new Date(booking.booking_date).toLocaleDateString('id-ID')}</div>
                      <div className="font-semibold whitespace-nowrap">{booking.booking_details?.booking_time || booking.booking_time || '09:00'}</div>
                    </td>
                    <td className="py-2 px-2 text-xs text-gray-600 text-center align-top border-r border-gray-200">
                      <div className="whitespace-nowrap">
                        {booking.booking_details?.booking_date_end ? new Date(booking.booking_details.booking_date_end).toLocaleDateString('id-ID') : new Date(booking.booking_date).toLocaleDateString('id-ID')}
                      </div>
                      <div className="font-semibold whitespace-nowrap">{booking.booking_details?.booking_time_end || booking.booking_time_end || '17:00'}</div>
                    </td>
                    <td className="py-2 px-2 text-xs font-semibold text-gray-900 text-right align-top border-r border-gray-200 whitespace-nowrap">
                      Rp {Math.round((booking.total_amount || 0) / bookingDays).toLocaleString('id-ID')}
                    </td>
                    <td className="py-2 px-3 text-xs font-semibold text-gray-900 text-right align-top">
                      <div className="whitespace-nowrap">Rp {Math.round(booking.total_amount || 0).toLocaleString('id-ID')}</div>
                      {bookingDays > 1 && <div className="text-xs text-gray-500 mt-1 break-words">(Rp {Math.round((booking.total_amount || 0) / bookingDays).toLocaleString('id-ID')} x {bookingDays} hari)</div>}
                    </td>
                  </tr>
                )}
                
                {/* Additional Fees */}
                {amounts.additional_fees && amounts.additional_fees.length > 0 && amounts.additional_fees.map((fee, index) => (
                  <tr key={`fee-${index}`} className="border-b border-gray-200">
                    <td className="py-2 px-3 text-xs font-semibold text-gray-900 align-top border-r border-gray-200 break-words">{fee.description}</td>
                    <td className="py-2 px-2 text-xs text-gray-600 text-center align-top border-r border-gray-200">-</td>
                    <td className="py-2 px-2 text-xs text-gray-600 text-center align-top border-r border-gray-200">-</td>
                    <td className="py-2 px-2 text-xs font-semibold text-gray-900 text-right align-top border-r border-gray-200 whitespace-nowrap">
                      Rp {Math.round(fee.amount).toLocaleString('id-ID')}
                    </td>
                    <td className="py-2 px-3 text-xs font-semibold text-gray-900 text-right align-top whitespace-nowrap">
                      Rp {Math.round(fee.amount).toLocaleString('id-ID')}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>

              {/* Totals Section - Ultra Compact */}
              <div className="flex justify-end mt-1">
                <div className="w-40 sm:w-48 md:w-56 lg:w-64 space-y-0.5 sm:space-y-1">
                  {/* Services Subtotal */}
                  <div className="flex justify-between text-xs">
                    <span className="text-gray-600">Subtotal Layanan:</span>
                    <span className="font-semibold">Rp {Math.round(amounts.servicesSubtotal).toLocaleString('id-ID')}</span>
                  </div>

                  {/* Discount */}
                  {amounts.discountAmount > 0 && (
                    <div className="flex justify-between text-xs">
                      <span className="text-gray-600">Diskon ({amounts.discountType === 'persen' ? `${amounts.discount}%` : 'Rp'}):</span>
                      <span className="font-semibold text-green-600">-Rp {Math.round(amounts.discountAmount).toLocaleString('id-ID')}</span>
                    </div>
                  )}

                  {/* Tax */}
                  {amounts.tax_percentage > 0 && (
                    <div className="flex justify-between text-xs">
                      <span className="text-gray-600">PPN ({amounts.tax_percentage}%):</span>
                      <span className="font-semibold">Rp {Math.round(amounts.tax).toLocaleString('id-ID')}</span>
                    </div>
                  )}

                  {/* Additional Fees Total */}
                  {amounts.additional_fees && amounts.additional_fees.length > 0 && (
                    <div className="flex justify-between text-xs">
                      <span className="text-gray-600">Biaya Tambahan:</span>
                      <span className="font-semibold">Rp {Math.round(amounts.additional_fees.reduce((sum, fee) => sum + parseFloat(fee.amount || 0), 0)).toLocaleString('id-ID')}</span>
                    </div>
                  )}

                  {/* Grand Total */}
                  <div className="flex justify-between text-xs font-bold border-t-2 pt-1 mt-1">
                    <span className="text-gray-900">TOTAL KESELURUHAN:</span>
                    <span className="text-blue-600">Rp {Math.round(amounts.total).toLocaleString('id-ID')}</span>
                  </div>

                  {/* Payment Information */}
                  {invoiceType === 'dp' && (
                    <>
                      <div className="border-t pt-1 mt-1"></div>
                      <div className="flex justify-between text-xs p-1 rounded">
                        <span className="text-gray-700 font-medium">DP yang harus dibayar:</span>
                        <span className="font-bold text-orange-600">Rp {Math.round(amounts.dp).toLocaleString('id-ID')}</span>
                      </div>
                      <div className="flex justify-between text-xs">
                        <span className="text-gray-600">Sisa Pembayaran:</span>
                        <span className="font-semibold text-red-600">Rp {Math.round(amounts.remaining).toLocaleString('id-ID')}</span>
                      </div>
                    </>
                  )}
                  {invoiceType === 'pelunasan' && (
                    <>
                      <div className="border-t pt-1 mt-1"></div>
                      <div className="flex justify-between text-xs text-gray-500 italic">
                        <span>Sudah Dibayar (DP):</span>
                        <span>-Rp {Math.round(booking.amount_paid || 0).toLocaleString('id-ID')}</span>
                      </div>
                      <div className="flex justify-between p-1 rounded">
                        <span className="font-bold text-gray-900 text-xs">Sisa yang Harus Dibayar:</span>
                        <span className="font-bold text-xs text-red-600">Rp {Math.round(amounts.remaining).toLocaleString('id-ID')}</span>
                      </div>
                    </>
                  )}
                  {invoiceType === 'penuh' && (
                    <>
                      <div className="border-t pt-1 mt-1"></div>
                      <div className="flex justify-between p-1 rounded">
                        <span className="font-bold text-gray-900 text-xs">Total Pembayaran Penuh:</span>
                        <span className="font-bold text-xs text-green-600">Rp {Math.round(amounts.total).toLocaleString('id-ID')}</span>
                      </div>
                    </>
                  )}
                </div>
              </div>

            {/* Informasi Pembayaran - Ultra Compact */}
            <div className="bg-gray-50 border border-gray-300 rounded p-1 mt-1 w-3/4 mx-auto">
              <h3 className="text-xs font-bold text-gray-900 mb-0.5">Informasi Pembayaran</h3>

              <div className="space-y-0 text-xs">
                <div className="flex gap-1">
                  <span className="text-gray-700">Status:</span>
                  <span className="font-bold text-gray-900">
                    {invoiceType === 'dp' ? 'Down Payment' : invoiceType === 'pelunasan' ? 'Pelunasan' : invoiceType === 'penuh' ? 'Lunas' : '-'}
                  </span>
                </div>

                <div className="flex gap-1">
                  <span className="text-gray-700">Sudah Dibayar:</span>
                  <span className="font-bold text-gray-900 whitespace-nowrap">
                    Rp {Math.round(booking.amount_paid || 0).toLocaleString('id-ID')}
                  </span>
                </div>
              </div>

              {/* Sisa Pembayaran Box - Orange Highlight Compact */}
              <div className="bg-orange-100 border border-orange-400 rounded p-1 text-center mt-1 w-3/5 mx-auto">
                <p className="text-xs font-medium text-orange-900 mb-0">
                  {invoiceType === 'dp' ? 'Pembayaran Awal' : invoiceType === 'pelunasan' ? 'Sisa Pembayaran' : invoiceType === 'penuh' ? 'Total Pembayaran' : 'Sisa pembayaran yang harus ditransfer'}
                </p>
                <p className="text-base font-bold text-orange-600 whitespace-nowrap mb-2">
                  Rp {Math.round(getInvoiceAmount()).toLocaleString('id-ID')}
                </p>
              </div>

              {/* Transfer Bank Section - Horizontal Layout */}
              {(companySettings?.bank_name || companySettings?.bank_name_alt) && (
                <div className="mt-1 w-3/4 mx-auto">
                  <h4 className="text-xs font-bold text-gray-900 mb-1">Transfer Bank:</h4>
                  <div className="grid grid-cols-2 gap-1">
                    {companySettings.bank_name && (
                      <div className="bg-white border border-gray-300 rounded p-1.5">
                        <div className="text-xs space-y-0.5">
                          <div className="flex justify-between">
                            <span className="text-gray-700">Bank:</span>
                            <span className="font-bold text-gray-900">{companySettings.bank_name}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-gray-700">No. Rekening:</span>
                            <span className="font-bold text-gray-900 font-mono">{companySettings.account_number || '-'}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-gray-700">A.n:</span>
                            <span className="font-bold text-gray-900">{companySettings.account_holder_name || '-'}</span>
                          </div>
                        </div>
                      </div>
                    )}

                    {companySettings.bank_name_alt && (
                      <div className="bg-white border border-gray-300 rounded p-1.5">
                        <div className="text-xs space-y-0.5">
                          <div className="flex justify-between">
                            <span className="text-gray-700">Bank:</span>
                            <span className="font-bold text-gray-900">{companySettings.bank_name_alt}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-gray-700">No. Rekening:</span>
                            <span className="font-bold text-gray-900 font-mono">{companySettings.account_number_alt || '-'}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-gray-700">A.n:</span>
                            <span className="font-bold text-gray-900">{companySettings.account_holder_name_alt || '-'}</span>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>

            {/* Instructions - Ultra Compact */}
            <div className="bg-orange-50 border border-orange-400 rounded p-2 mt-1 w-3/4 mx-auto">
              <h4 className="text-xs font-bold text-gray-900 mb-1">Instruksi Pembayaran:</h4>
              <p className="text-xs text-gray-800 leading-relaxed">
                {companySettings?.payment_instructions || 'Silakan transfer ke rekening di atas dan kirimkan bukti transfer untuk konfirmasi pembayaran.'}
              </p>
            </div>

            {/* Footer - Clean */}
            <div className="text-center text-xs text-gray-500 border-t pt-1 mt-2 w-3/4 mx-auto">
              <p>Invoice otomatis - {companySettings?.company_name || 'Nama Perusahaan'}</p>
            </div>
          </div>
        </div>
      )}

      {/* Download Modal */}
      {showDownloadModal && (
        <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[60] p-4">
          <div className="bg-white rounded-lg sm:rounded-xl shadow-2xl w-full max-w-md p-4 sm:p-6">
            <h3 className="text-lg sm:text-xl font-bold text-gray-900 mb-3 sm:mb-4">Download Invoice</h3>
            
            <div className="mb-3 sm:mb-4">
              <label className="block text-xs sm:text-sm font-semibold text-gray-700 mb-1 sm:mb-2">
                Nama File:
              </label>
              <input
                type="text"
                value={fileName}
                onChange={(e) => setFileName(e.target.value)}
                className="w-full px-3 sm:px-4 py-2 sm:py-2.5 border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                placeholder="Masukkan nama file"
              />
              <p className="text-xs text-gray-500 mt-1">
                File akan disimpan sebagai: <span className="font-semibold">{fileName}.{downloadFormat === 'pdf' ? 'pdf' : 'jpg'}</span>
              </p>
            </div>

            <div className="mb-4 sm:mb-6">
              <label className="block text-xs sm:text-sm font-semibold text-gray-700 mb-2">
                Format:
              </label>
              <div className="flex gap-2 sm:gap-3">
                <button
                  onClick={() => setDownloadFormat('pdf')}
                  className={`flex-1 py-2 sm:py-2.5 px-3 sm:px-4 rounded-lg border-2 font-semibold transition-all text-sm sm:text-base ${
                    downloadFormat === 'pdf'
                      ? 'bg-blue-500 border-blue-500 text-white'
                      : 'bg-white border-gray-300 text-gray-700 hover:border-blue-400'
                  }`}
                >
                  📄 PDF
                </button>
                <button
                  onClick={() => setDownloadFormat('jpeg')}
                  className={`flex-1 py-2 sm:py-2.5 px-3 sm:px-4 rounded-lg border-2 font-semibold transition-all text-sm sm:text-base ${
                    downloadFormat === 'jpeg'
                      ? 'bg-blue-500 border-blue-500 text-white'
                      : 'bg-white border-gray-300 text-gray-700 hover:border-blue-400'
                  }`}
                >
                  🖼️ JPEG
                </button>
              </div>
            </div>

            <div className="flex flex-col sm:flex-row gap-2 sm:gap-3">
              <Button
                variant="secondary"
                onClick={() => setShowDownloadModal(false)}
                className="flex-1 px-4 py-2 sm:py-2.5 text-sm sm:text-base"
              >
                Batal
              </Button>
              <Button
                variant="primary"
                onClick={executeDownload}
                className="flex-1 px-4 py-2 sm:py-2.5 text-sm sm:text-base"
              >
                Download
              </Button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
};

export default GenerateInvoiceModal;
